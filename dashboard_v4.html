<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PolyEdge v4 — Command Center</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Rajdhani:wght@300;400;500;600;700&family=Fira+Code:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg-0: #040810;
  --bg-1: rgba(8,16,32,0.85);
  --bg-2: rgba(14,25,50,0.7);
  --bg-3: rgba(20,35,65,0.6);
  --bg-solid-1: #081020;
  --bg-solid-2: #0e1932;
  --border: rgba(0,180,216,0.12);
  --border-active: rgba(0,180,216,0.3);
  --border-glow: rgba(0,180,216,0.5);
  --text-0: #e4eef8;
  --text-1: #8aa4c0;
  --text-2: #4a6a8a;
  --green: #06d6a0;
  --green-dim: #04a87e;
  --red: #ef476f;
  --red-dim: #c22a52;
  --amber: #ffd166;
  --amber-dim: #e6b84d;
  --cyan: #00b4d8;
  --cyan-bright: #48cae4;
  --purple: #7209b7;
  --purple-light: #a855f7;
  --blue: #4895ef;
  --surface-glass: rgba(10,20,40,0.65);
  --glow-cyan: 0 0 20px rgba(0,180,216,0.15), 0 0 60px rgba(0,180,216,0.05);
  --glow-hover: 0 0 30px rgba(0,180,216,0.25), 0 0 80px rgba(0,180,216,0.08);
  --heading: 'Orbitron', sans-serif;
  --sans: 'Rajdhani', sans-serif;
  --mono: 'Fira Code', monospace;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

html { scroll-behavior: smooth; }

body {
  background: var(--bg-0);
  color: var(--text-0);
  font-family: var(--mono);
  font-size: 13px;
  line-height: 1.5;
  overflow-x: hidden;
  min-height: 100vh;
}

/* ── Animated Background ── */
body::before {
  content: '';
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background:
    radial-gradient(ellipse 80% 50% at 20% 40%, rgba(0,180,216,0.06) 0%, transparent 50%),
    radial-gradient(ellipse 60% 40% at 80% 20%, rgba(114,9,183,0.05) 0%, transparent 50%),
    radial-gradient(ellipse 70% 60% at 50% 90%, rgba(6,214,160,0.04) 0%, transparent 50%);
  z-index: 0;
  pointer-events: none;
  animation: bgShift 20s ease-in-out infinite alternate;
}

@keyframes bgShift {
  0% { opacity: 0.6; }
  50% { opacity: 1; }
  100% { opacity: 0.7; }
}

/* Noise texture overlay */
body::after {
  content: '';
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
  z-index: 0;
  pointer-events: none;
  opacity: 0.4;
}

/* Scanline effect */
.scanline-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: repeating-linear-gradient(
    0deg,
    transparent,
    transparent 2px,
    rgba(0,180,216,0.008) 2px,
    rgba(0,180,216,0.008) 4px
  );
  z-index: 1;
  pointer-events: none;
}

/* Everything else above background */
.header, .tab-bar, .tab-content, .grid { position: relative; z-index: 2; }

/* ── Scrollbar ── */
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb {
  background: linear-gradient(180deg, var(--cyan), var(--purple));
  border-radius: 10px;
}
::-webkit-scrollbar-thumb:hover { background: var(--cyan-bright); }

/* ── Animations ── */
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(12px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes pulseGlow {
  0%, 100% { box-shadow: 0 0 8px rgba(0,180,216,0.3); }
  50% { box-shadow: 0 0 20px rgba(0,180,216,0.6); }
}
@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}
@keyframes pulse-red {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}
@keyframes borderFlow {
  0% { background-position: 0% 50%; }
  100% { background-position: 200% 50%; }
}
@keyframes ringPulse {
  0% { transform: scale(1); opacity: 1; }
  100% { transform: scale(2.5); opacity: 0; }
}
@keyframes shimmer {
  0% { background-position: -200% 0; }
  100% { background-position: 200% 0; }
}

/* ── Header ── */
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 24px;
  background: rgba(6,12,24,0.9);
  backdrop-filter: blur(24px) saturate(150%);
  -webkit-backdrop-filter: blur(24px) saturate(150%);
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  z-index: 100;
}
.header::after {
  content: '';
  position: absolute;
  bottom: -1px;
  left: 0;
  right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--cyan), var(--purple), var(--cyan), transparent);
  opacity: 0.5;
  animation: borderFlow 4s linear infinite;
  background-size: 200% 100%;
}

.header-left { display: flex; align-items: center; gap: 18px; }
.logo {
  font-family: var(--heading);
  font-weight: 800;
  font-size: 20px;
  letter-spacing: 3px;
  background: linear-gradient(135deg, var(--cyan-bright) 0%, var(--cyan) 40%, var(--purple-light) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  text-shadow: none;
  position: relative;
}
.logo span {
  font-family: var(--sans);
  font-weight: 400;
  font-size: 11px;
  letter-spacing: 1px;
  -webkit-text-fill-color: var(--text-2);
  margin-left: 8px;
  vertical-align: super;
}

.mode-badge {
  padding: 4px 14px;
  border-radius: 20px;
  font-family: var(--heading);
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 2px;
}
.mode-paper {
  background: rgba(255,209,102,0.1);
  color: var(--amber);
  border: 1px solid rgba(255,209,102,0.25);
  box-shadow: 0 0 12px rgba(255,209,102,0.1);
}
.mode-live {
  background: rgba(239,71,111,0.12);
  color: var(--red);
  border: 1px solid rgba(239,71,111,0.3);
  animation: pulse-red 2s infinite;
  box-shadow: 0 0 12px rgba(239,71,111,0.15);
}

.header-right { display: flex; align-items: center; gap: 28px; }
.header-stat { text-align: right; }
.header-stat-label {
  font-family: var(--sans);
  font-size: 10px;
  color: var(--text-2);
  text-transform: uppercase;
  letter-spacing: 2px;
  font-weight: 500;
}
.header-stat-value {
  font-family: var(--heading);
  font-size: 17px;
  font-weight: 600;
  letter-spacing: 1px;
}
.stat-positive { color: var(--green); text-shadow: 0 0 12px rgba(6,214,160,0.4); }
.stat-negative { color: var(--red); text-shadow: 0 0 12px rgba(239,71,111,0.4); }
.stat-neutral { color: var(--text-1); }

.uptime {
  font-family: var(--sans);
  font-size: 12px;
  color: var(--text-2);
  font-weight: 500;
  letter-spacing: 0.5px;
}
.status-dot {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-right: 6px;
  position: relative;
}
.status-dot::after {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  border-radius: 50%;
  animation: ringPulse 2s ease-out infinite;
}
.dot-green { background: var(--green); box-shadow: 0 0 8px var(--green); }
.dot-green::after { background: var(--green); }
.dot-red { background: var(--red); box-shadow: 0 0 8px var(--red); }
.dot-red::after { background: var(--red); }
.dot-amber { background: var(--amber); box-shadow: 0 0 8px var(--amber); }
.dot-amber::after { background: var(--amber); }

/* ── Tab Bar ── */
.tab-bar {
  display: flex;
  align-items: center;
  gap: 4px;
  background: rgba(6,12,24,0.7);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border-bottom: 1px solid var(--border);
  padding: 8px 24px;
  position: relative;
  z-index: 99;
}
.tab-btn {
  background: transparent;
  border: 1px solid transparent;
  color: var(--text-2);
  font-family: var(--heading);
  font-size: 11px;
  font-weight: 500;
  letter-spacing: 2px;
  text-transform: uppercase;
  padding: 8px 20px;
  cursor: pointer;
  border-radius: 6px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
}
.tab-btn:hover {
  color: var(--text-0);
  background: rgba(0,180,216,0.06);
  border-color: rgba(0,180,216,0.15);
}
.tab-btn.active {
  color: var(--cyan-bright);
  background: rgba(0,180,216,0.1);
  border-color: rgba(0,180,216,0.3);
  box-shadow: 0 0 15px rgba(0,180,216,0.12), inset 0 0 15px rgba(0,180,216,0.05);
}

.tab-content { display: none; }
.tab-content.active { display: block; animation: fadeInUp 0.35s ease-out; }

/* ── Grid ── */
.grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  grid-template-rows: auto auto auto;
  gap: 12px;
  padding: 16px;
  min-height: calc(100vh - 100px);
}

/* ── Panel (Glass Card) ── */
.panel {
  background: var(--bg-1);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border: 1px solid var(--border);
  border-radius: 10px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  transition: all 0.3s ease;
  animation: fadeInUp 0.5s ease-out both;
}
.panel:nth-child(1) { animation-delay: 0.05s; }
.panel:nth-child(2) { animation-delay: 0.1s; }
.panel:nth-child(3) { animation-delay: 0.15s; }
.panel:nth-child(4) { animation-delay: 0.2s; }
.panel:nth-child(5) { animation-delay: 0.25s; }
.panel:nth-child(6) { animation-delay: 0.3s; }
.panel:nth-child(7) { animation-delay: 0.35s; }
.panel:nth-child(8) { animation-delay: 0.4s; }

.panel:hover {
  border-color: var(--border-active);
  box-shadow: var(--glow-hover);
  transform: translateY(-1px);
}

.panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  background: linear-gradient(135deg, rgba(0,180,216,0.04) 0%, transparent 60%);
}
.panel-title {
  font-family: var(--heading);
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 2.5px;
  color: var(--text-1);
}
.panel-tag {
  font-family: var(--sans);
  font-size: 10px;
  font-weight: 600;
  padding: 3px 10px;
  border-radius: 20px;
  letter-spacing: 0.5px;
}
.tag-engine { background: rgba(0,180,216,0.1); color: var(--cyan); border: 1px solid rgba(0,180,216,0.2); }
.tag-feed { background: rgba(168,85,247,0.1); color: var(--purple-light); border: 1px solid rgba(168,85,247,0.2); }
.tag-meta { background: rgba(72,149,239,0.1); color: var(--blue); border: 1px solid rgba(72,149,239,0.2); }
.tag-risk { background: rgba(239,71,111,0.1); color: var(--red); border: 1px solid rgba(239,71,111,0.2); }

.panel-body {
  flex: 1;
  padding: 14px 16px;
  overflow-y: auto;
}

/* ── Span columns ── */
.span-2 { grid-column: span 2; }
.span-3 { grid-column: span 3; }
.span-4 { grid-column: span 4; }

/* ── Data Table ── */
.dtable { width: 100%; border-collapse: separate; border-spacing: 0; }
.dtable th {
  text-align: left;
  font-family: var(--sans);
  font-size: 10px;
  font-weight: 600;
  color: var(--text-2);
  text-transform: uppercase;
  letter-spacing: 1.5px;
  padding: 6px 4px;
  border-bottom: 1px solid var(--border);
}
.dtable td {
  padding: 7px 4px;
  border-bottom: 1px solid rgba(0,180,216,0.06);
  font-size: 12px;
  transition: background 0.2s;
}
.dtable tr:hover td { background: rgba(0,180,216,0.04); }

/* ── Metric Grid ── */
.metrics {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
}
.metric {
  background: linear-gradient(135deg, rgba(0,180,216,0.03) 0%, rgba(114,9,183,0.02) 100%);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 12px 14px;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}
.metric::before {
  content: '';
  position: absolute;
  top: 0; left: 0;
  width: 3px;
  height: 100%;
  background: linear-gradient(180deg, var(--cyan), transparent);
  opacity: 0;
  transition: opacity 0.3s;
}
.metric:hover::before { opacity: 1; }
.metric:hover { border-color: var(--border-active); }

.metric-label {
  font-family: var(--sans);
  font-size: 10px;
  color: var(--text-2);
  text-transform: uppercase;
  letter-spacing: 1.5px;
  font-weight: 600;
  margin-bottom: 4px;
}
.metric-value {
  font-family: var(--heading);
  font-size: 18px;
  font-weight: 600;
  letter-spacing: 0.5px;
}
.metrics-3 { grid-template-columns: repeat(3, 1fr); }

/* ── Signal Row ── */
.signal-row {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  border-radius: 8px;
  margin-bottom: 6px;
  background: rgba(0,180,216,0.03);
  border: 1px solid transparent;
  border-left: 3px solid transparent;
  transition: all 0.25s ease;
}
.signal-row:hover {
  background: rgba(0,180,216,0.06);
  border-color: var(--border);
}
.signal-buy { border-left-color: var(--green); }
.signal-sell { border-left-color: var(--red); }
.signal-info { flex: 1; min-width: 0; }
.signal-market {
  font-family: var(--sans);
  font-size: 12px;
  font-weight: 600;
  color: var(--text-0);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.signal-detail {
  font-size: 10px;
  color: var(--text-2);
  margin-top: 3px;
  font-family: var(--mono);
}
.signal-badge {
  font-family: var(--heading);
  font-size: 9px;
  padding: 3px 8px;
  border-radius: 12px;
  font-weight: 600;
  letter-spacing: 1px;
  white-space: nowrap;
}
.badge-critical { background: rgba(239,71,111,0.15); color: var(--red); border: 1px solid rgba(239,71,111,0.3); }
.badge-high { background: rgba(255,209,102,0.12); color: var(--amber); border: 1px solid rgba(255,209,102,0.25); }
.badge-medium { background: rgba(72,149,239,0.12); color: var(--blue); border: 1px solid rgba(72,149,239,0.25); }
.badge-low { background: rgba(74,106,138,0.15); color: var(--text-2); border: 1px solid rgba(74,106,138,0.2); }

/* ── PnL Bar ── */
.pnl-bar { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
.pnl-bar-label {
  font-family: var(--sans);
  font-size: 11px;
  font-weight: 600;
  color: var(--text-2);
  width: 50px;
  letter-spacing: 0.5px;
  text-transform: uppercase;
}
.pnl-bar-track {
  flex: 1;
  height: 18px;
  background: rgba(0,0,0,0.3);
  border-radius: 9px;
  overflow: hidden;
  position: relative;
  border: 1px solid var(--border);
}
.pnl-bar-fill {
  height: 100%;
  border-radius: 9px;
  transition: width 0.5s ease;
  position: absolute;
}
.pnl-bar-value {
  font-family: var(--heading);
  font-size: 11px;
  font-weight: 500;
  width: 65px;
  text-align: right;
  letter-spacing: 0.5px;
}

/* ── Event Log ── */
.log-entry {
  display: flex;
  gap: 10px;
  padding: 5px 0;
  border-bottom: 1px solid rgba(0,180,216,0.05);
  font-size: 11px;
  transition: background 0.2s;
}
.log-entry:hover { background: rgba(0,180,216,0.03); }
.log-time { color: var(--text-2); white-space: nowrap; width: 55px; flex-shrink: 0; font-family: var(--mono); }
.log-type { font-family: var(--sans); font-weight: 700; width: 70px; flex-shrink: 0; }
.log-msg { color: var(--text-1); flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

/* ── Inventory Bars ── */
.inv-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
.inv-label {
  font-family: var(--sans);
  font-size: 11px;
  font-weight: 500;
  min-width: 140px;
  max-width: 180px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  color: var(--text-1);
}
.inv-link {
  color: var(--text-1);
  text-decoration: none;
  transition: color 0.2s;
}
.inv-link:hover { color: var(--cyan); }
.quote-market-cell {
  max-width: 260px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.quote-market-link {
  color: var(--cyan);
  text-decoration: none;
  transition: color 0.2s;
}
.quote-market-link:hover { color: var(--cyan-bright); text-decoration: underline; }
.inv-track {
  flex: 1;
  height: 22px;
  background: rgba(0,0,0,0.3);
  border-radius: 11px;
  position: relative;
  overflow: hidden;
  border: 1px solid var(--border);
}
.inv-fill-long, .inv-fill-short {
  position: absolute;
  height: 100%;
  top: 0;
  transition: width 0.4s ease;
}
.inv-fill-long {
  left: 50%;
  background: linear-gradient(90deg, rgba(6,214,160,0.3), rgba(6,214,160,0.6));
  border-radius: 0 11px 11px 0;
}
.inv-fill-short {
  right: 50%;
  background: linear-gradient(270deg, rgba(239,71,111,0.3), rgba(239,71,111,0.6));
  border-radius: 11px 0 0 11px;
}
.inv-center {
  position: absolute;
  left: 50%;
  top: 0; bottom: 0;
  width: 1px;
  background: var(--text-2);
  opacity: 0.4;
}
.inv-value {
  font-family: var(--heading);
  font-size: 11px;
  font-weight: 500;
  width: 55px;
  text-align: right;
}

/* ── Meta Report ── */
.meta-card {
  background: rgba(0,180,216,0.03);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 14px;
  margin-bottom: 10px;
  transition: border-color 0.3s;
}
.meta-card:hover { border-color: var(--border-active); }
.meta-card-title {
  font-family: var(--heading);
  font-size: 9px;
  color: var(--cyan);
  text-transform: uppercase;
  letter-spacing: 2px;
  margin-bottom: 8px;
}
.meta-card-text {
  font-family: var(--sans);
  font-size: 13px;
  color: var(--text-1);
  line-height: 1.7;
  font-weight: 400;
}

.adj-row {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 10px;
  background: rgba(0,0,0,0.2);
  border: 1px solid var(--border);
  border-radius: 6px;
  margin-top: 5px;
  font-size: 11px;
}
.adj-engine {
  font-family: var(--heading);
  color: var(--cyan);
  font-weight: 600;
  font-size: 9px;
  letter-spacing: 1px;
  width: 55px;
}
.adj-param { color: var(--text-0); flex: 1; font-family: var(--sans); font-weight: 500; }
.adj-change { color: var(--amber); font-weight: 500; white-space: nowrap; font-family: var(--mono); }

/* ── Empty State ── */
.empty-state {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: var(--text-2);
  font-family: var(--sans);
  font-size: 13px;
  font-weight: 400;
  letter-spacing: 0.5px;
  opacity: 0.7;
}

/* ── Trades Tab ── */
.trades-container { padding: 20px 24px; max-width: 1400px; margin: 0 auto; }
.trades-section { margin-bottom: 28px; }
.trades-section-title {
  font-family: var(--heading);
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 3px;
  color: var(--text-2);
  margin-bottom: 14px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--border);
  position: relative;
}
.trades-section-title::after {
  content: '';
  position: absolute;
  bottom: -1px;
  left: 0;
  width: 60px;
  height: 1px;
  background: linear-gradient(90deg, var(--cyan), transparent);
}

.trades-table { width: 100%; border-collapse: separate; border-spacing: 0; }
.trades-table th {
  text-align: left;
  font-family: var(--sans);
  font-size: 10px;
  font-weight: 600;
  color: var(--text-2);
  text-transform: uppercase;
  letter-spacing: 1.5px;
  padding: 8px 10px;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  user-select: none;
  transition: color 0.2s;
}
.trades-table th:hover { color: var(--cyan); }
.trades-table td {
  padding: 8px 10px;
  border-bottom: 1px solid rgba(0,180,216,0.06);
  font-size: 12px;
  transition: background 0.2s;
}
.trades-table tr:hover td { background: rgba(0,180,216,0.04); }

/* ── PnL Tab ── */
.pnl-container { padding: 20px 24px; max-width: 1400px; margin: 0 auto; }
.chart-wrapper {
  background: var(--bg-1);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 16px;
  transition: border-color 0.3s;
}
.chart-wrapper:hover { border-color: var(--border-active); }

.chart-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
}
.chart-title {
  font-family: var(--heading);
  font-size: 12px;
  font-weight: 600;
  color: var(--text-0);
  letter-spacing: 2px;
  text-transform: uppercase;
}
.chart-range { display: flex; gap: 6px; }
.range-btn {
  background: rgba(0,0,0,0.3);
  border: 1px solid var(--border);
  color: var(--text-2);
  font-family: var(--heading);
  font-size: 10px;
  font-weight: 500;
  letter-spacing: 1px;
  padding: 5px 14px;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.25s ease;
}
.range-btn:hover { color: var(--text-0); border-color: var(--border-active); }
.range-btn.active {
  color: var(--cyan-bright);
  border-color: var(--cyan);
  background: rgba(0,180,216,0.1);
  box-shadow: 0 0 10px rgba(0,180,216,0.15);
}
#pnl-canvas { width: 100%; height: 300px; display: block; }
.pnl-legend {
  display: flex;
  gap: 24px;
  justify-content: center;
  padding-top: 14px;
  font-family: var(--sans);
  font-size: 12px;
  font-weight: 500;
  color: var(--text-2);
  letter-spacing: 0.5px;
}
.legend-dot {
  display: inline-block;
  width: 12px;
  height: 3px;
  border-radius: 2px;
  margin-right: 8px;
  vertical-align: middle;
}

/* ── Config Tab ── */
.config-container { padding: 20px 24px; max-width: 1000px; margin: 0 auto; }
.config-section {
  background: var(--bg-1);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border: 1px solid var(--border);
  border-radius: 10px;
  margin-bottom: 14px;
  overflow: hidden;
  transition: all 0.3s ease;
  animation: fadeInUp 0.4s ease-out both;
}
.config-section:nth-child(1) { animation-delay: 0.05s; }
.config-section:nth-child(2) { animation-delay: 0.1s; }
.config-section:nth-child(3) { animation-delay: 0.15s; }
.config-section:nth-child(4) { animation-delay: 0.2s; }
.config-section:hover { border-color: var(--border-active); }

.config-section-header {
  padding: 12px 16px;
  background: linear-gradient(135deg, rgba(0,180,216,0.06) 0%, rgba(114,9,183,0.03) 100%);
  border-bottom: 1px solid var(--border);
  font-family: var(--heading);
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 3px;
  color: var(--cyan);
}
.config-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 16px;
  border-bottom: 1px solid rgba(0,180,216,0.06);
  transition: background 0.2s;
}
.config-row:last-child { border-bottom: none; }
.config-row:hover { background: rgba(0,180,216,0.03); }
.config-key {
  font-family: var(--sans);
  font-size: 13px;
  font-weight: 500;
  color: var(--text-2);
  letter-spacing: 0.3px;
}
.config-val {
  font-family: var(--heading);
  font-size: 12px;
  font-weight: 500;
  color: var(--text-0);
  letter-spacing: 1px;
}

/* ── Responsive ── */
@media (max-width: 1200px) {
  .grid { grid-template-columns: repeat(2, 1fr); }
  .span-3 { grid-column: span 2; }
  .span-4 { grid-column: span 2; }
}
@media (max-width: 768px) {
  .grid { grid-template-columns: 1fr; gap: 10px; padding: 10px; }
  .span-2, .span-3, .span-4 { grid-column: span 1; }
  .header { flex-direction: column; gap: 10px; padding: 12px 16px; }
  .header-right { gap: 16px; }
  .tab-bar { overflow-x: auto; padding: 6px 12px; }
  .tab-btn { white-space: nowrap; padding: 6px 14px; font-size: 10px; }
  .trades-container, .pnl-container, .config-container { padding: 12px; }
  .logo { font-size: 16px; }
}
</style>
</head>
<body>

<!-- Scanline overlay -->
<div class="scanline-overlay"></div>

<!-- Header -->
<div class="header">
  <div class="header-left">
    <div class="logo">POLYEDGE<span>v4.0</span></div>
    <div class="mode-badge mode-paper" id="mode-badge">PAPER</div>
    <div class="uptime">
      <span class="status-dot dot-green" id="status-dot"></span>
      <span id="uptime">0h 0m</span>
    </div>
  </div>
  <div class="header-right">
    <div class="header-stat">
      <div class="header-stat-label">Total PnL</div>
      <div class="header-stat-value stat-neutral" id="total-pnl">$0.00</div>
    </div>
    <div class="header-stat">
      <div class="header-stat-label">Exposure</div>
      <div class="header-stat-value stat-neutral" id="total-exposure">$0 / $500</div>
    </div>
    <div class="header-stat">
      <div class="header-stat-label">Engines</div>
      <div class="header-stat-value stat-neutral" id="engine-count">0 / 3</div>
    </div>
  </div>
</div>

<!-- Tab Bar -->
<div class="tab-bar">
  <button class="tab-btn active" data-tab="dashboard">Dashboard</button>
  <button class="tab-btn" data-tab="trades">Trades</button>
  <button class="tab-btn" data-tab="pnl">PnL</button>
  <button class="tab-btn" data-tab="config">Config</button>
</div>

<!-- Tab: Dashboard (default) -->
<div class="tab-content active" id="tab-dashboard">
<div class="grid">

  <!-- Panel 1: System Status -->
  <div class="panel">
    <div class="panel-header">
      <span class="panel-title">System Status</span>
      <span class="panel-tag tag-risk">LIVE</span>
    </div>
    <div class="panel-body">
      <div class="metrics" id="system-metrics">
        <div class="metric">
          <div class="metric-label">Bankroll</div>
          <div class="metric-value" id="sys-bankroll">$5,000</div>
        </div>
        <div class="metric">
          <div class="metric-label">ROI</div>
          <div class="metric-value stat-neutral" id="sys-roi">0.00%</div>
        </div>
        <div class="metric">
          <div class="metric-label">MM Status</div>
          <div class="metric-value" id="sys-mm-status">—</div>
        </div>
        <div class="metric">
          <div class="metric-label">Sniper Status</div>
          <div class="metric-value" id="sys-sniper-status">—</div>
        </div>
        <div class="metric">
          <div class="metric-label">Meta Next Run</div>
          <div class="metric-value" id="sys-meta-next">—</div>
        </div>
        <div class="metric">
          <div class="metric-label">CLOB</div>
          <div class="metric-value" id="sys-clob">—</div>
        </div>
      </div>
      <!-- WS Feed Health -->
      <div style="margin-top:14px;padding-top:12px;border-top:1px solid var(--border)">
        <div style="font-family:var(--heading);font-size:9px;color:var(--text-2);text-transform:uppercase;letter-spacing:2px;margin-bottom:10px">Orderbook Feed</div>
        <div class="metrics">
          <div class="metric">
            <div class="metric-label">WS Status</div>
            <div class="metric-value" id="ws-status">
              <span class="status-dot" id="ws-dot" style="margin-right:4px"></span>
              <span id="ws-status-text">—</span>
            </div>
          </div>
          <div class="metric">
            <div class="metric-label">Subscribed</div>
            <div class="metric-value" id="ws-subscribed">0</div>
          </div>
          <div class="metric">
            <div class="metric-label">WS Hit Rate</div>
            <div class="metric-value" id="ws-hit-rate">—</div>
          </div>
          <div class="metric">
            <div class="metric-label">Last Msg</div>
            <div class="metric-value" id="ws-last-msg">—</div>
          </div>
          <div class="metric">
            <div class="metric-label">Reconnects</div>
            <div class="metric-value" id="ws-reconnects">0</div>
          </div>
          <div class="metric">
            <div class="metric-label">Book Updates</div>
            <div class="metric-value" id="ws-book-updates">0</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Panel 2: Market Maker Overview -->
  <div class="panel">
    <div class="panel-header">
      <span class="panel-title">Market Maker</span>
      <span class="panel-tag tag-engine">Engine 1</span>
    </div>
    <div class="panel-body">
      <div class="metrics metrics-3" id="mm-metrics">
        <div class="metric">
          <div class="metric-label">Markets</div>
          <div class="metric-value" id="mm-markets">0</div>
        </div>
        <div class="metric">
          <div class="metric-label">Quotes</div>
          <div class="metric-value" id="mm-quotes">0</div>
        </div>
        <div class="metric">
          <div class="metric-label">Fills</div>
          <div class="metric-value" id="mm-fills">0</div>
        </div>
      </div>
      <div style="margin-top:14px">
        <div class="pnl-bar">
          <span class="pnl-bar-label">Real</span>
          <div class="pnl-bar-track">
            <div class="pnl-bar-fill" id="mm-real-bar" style="width:50%;left:50%;background:var(--green)"></div>
          </div>
          <span class="pnl-bar-value stat-neutral" id="mm-real-pnl">$0.00</span>
        </div>
        <div class="pnl-bar">
          <span class="pnl-bar-label">Unreal</span>
          <div class="pnl-bar-track">
            <div class="pnl-bar-fill" id="mm-unreal-bar" style="width:50%;left:50%;background:var(--amber)"></div>
          </div>
          <span class="pnl-bar-value stat-neutral" id="mm-unreal-pnl">$0.00</span>
        </div>
      </div>
      <div id="mm-kill-switch" style="display:none;margin-top:10px;padding:8px 12px;background:rgba(239,71,111,0.1);border:1px solid rgba(239,71,111,0.3);border-radius:6px;font-family:var(--heading);font-size:10px;color:var(--red);font-weight:600;letter-spacing:1px;">
        ⚠ KILL SWITCH TRIGGERED
      </div>
    </div>
  </div>

  <!-- Panel 3: Quote Book -->
  <div class="panel span-2">
    <div class="panel-header">
      <span class="panel-title">Active Quotes</span>
      <span class="panel-tag tag-engine">MM Live</span>
    </div>
    <div class="panel-body">
      <table class="dtable" id="quote-table">
        <thead>
          <tr>
            <th>Market</th>
            <th>Bid</th>
            <th>Ask</th>
            <th>Spread</th>
            <th>Size</th>
            <th>Fair Value</th>
          </tr>
        </thead>
        <tbody id="quote-tbody">
          <tr><td colspan="6" class="empty-state">Waiting for quotes...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Panel 4: Inventory Heatmap -->
  <div class="panel">
    <div class="panel-header">
      <span class="panel-title">Inventory</span>
      <span class="panel-tag tag-risk">Risk</span>
    </div>
    <div class="panel-body" id="inventory-panel">
      <div class="empty-state">No positions</div>
    </div>
  </div>

  <!-- Panel 5: Sniper Feed -->
  <div class="panel">
    <div class="panel-header">
      <span class="panel-title">Sniper Trades</span>
      <span class="panel-tag tag-engine">Engine 2</span>
    </div>
    <div class="panel-body" id="sniper-panel">
      <div class="metrics" style="margin-bottom:14px">
        <div class="metric">
          <div class="metric-label">Trades</div>
          <div class="metric-value" id="sniper-trades">0</div>
        </div>
        <div class="metric">
          <div class="metric-label">Win Rate</div>
          <div class="metric-value" id="sniper-winrate">0%</div>
        </div>
      </div>
      <div id="sniper-positions"></div>
    </div>
  </div>

  <!-- Panel 6: Gap Radar -->
  <div class="panel span-2">
    <div class="panel-header">
      <span class="panel-title">Gap Radar</span>
      <span class="panel-tag tag-feed">Signals</span>
    </div>
    <div class="panel-body" id="gap-panel">
      <div class="empty-state">Waiting for events...</div>
    </div>
  </div>

  <!-- Panel 7: Live Events Log -->
  <div class="panel span-2">
    <div class="panel-header">
      <span class="panel-title">Event Log</span>
      <span class="panel-tag tag-feed">Feeds</span>
    </div>
    <div class="panel-body" id="event-log">
      <div class="empty-state">No events yet</div>
    </div>
  </div>

  <!-- Panel 8: Meta Strategist -->
  <div class="panel span-2">
    <div class="panel-header">
      <span class="panel-title">Meta Strategist</span>
      <span class="panel-tag tag-meta">Engine 3</span>
    </div>
    <div class="panel-body" id="meta-panel">
      <div class="metrics" style="margin-bottom:14px">
        <div class="metric">
          <div class="metric-label">Runs</div>
          <div class="metric-value" id="meta-runs">0</div>
        </div>
        <div class="metric">
          <div class="metric-label">LLM Cost</div>
          <div class="metric-value" id="meta-cost">$0.00</div>
        </div>
        <div class="metric">
          <div class="metric-label">Adjustments</div>
          <div class="metric-value" id="meta-adjustments">0</div>
        </div>
        <div class="metric">
          <div class="metric-label">Next Run</div>
          <div class="metric-value" id="meta-next-run">—</div>
        </div>
      </div>
      <div id="meta-reports"></div>
    </div>
  </div>

</div><!-- /.grid -->
</div><!-- /#tab-dashboard -->

<!-- Tab: Trades -->
<div class="tab-content" id="tab-trades">
  <div class="trades-container">
    <!-- Summary Metrics -->
    <div class="metrics" style="margin-bottom:24px">
      <div class="metric">
        <div class="metric-label">Total Trades</div>
        <div class="metric-value" id="trades-total">0</div>
      </div>
      <div class="metric">
        <div class="metric-label">Win Rate</div>
        <div class="metric-value" id="trades-winrate">0%</div>
      </div>
      <div class="metric">
        <div class="metric-label">Total PnL</div>
        <div class="metric-value stat-neutral" id="trades-pnl">$0.00</div>
      </div>
      <div class="metric">
        <div class="metric-label">Avg PnL</div>
        <div class="metric-value stat-neutral" id="trades-avg">$0.00</div>
      </div>
    </div>

    <!-- Active Positions -->
    <div class="trades-section">
      <div class="trades-section-title">Active Positions</div>
      <table class="trades-table">
        <thead>
          <tr>
            <th>Market</th>
            <th>Direction</th>
            <th>Size</th>
            <th>Entry</th>
            <th>Edge</th>
            <th>Age</th>
          </tr>
        </thead>
        <tbody id="trades-active-tbody">
          <tr><td colspan="6" class="empty-state">No active positions</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Completed Trades -->
    <div class="trades-section">
      <div class="trades-section-title">Completed Trades <span id="trades-completed-count" style="color:var(--text-2);font-weight:400">(0)</span></div>
      <table class="trades-table">
        <thead>
          <tr>
            <th data-sort="market">Market</th>
            <th data-sort="direction">Dir</th>
            <th data-sort="size">Size</th>
            <th data-sort="entry_price">Entry</th>
            <th data-sort="fill_price">Fill</th>
            <th data-sort="pnl">PnL</th>
            <th data-sort="status">Status</th>
          </tr>
        </thead>
        <tbody id="trades-completed-tbody">
          <tr><td colspan="7" class="empty-state">No completed trades</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Tab: PnL -->
<div class="tab-content" id="tab-pnl">
  <div class="pnl-container">
    <!-- Summary Stats -->
    <div class="metrics" style="margin-bottom:20px">
      <div class="metric">
        <div class="metric-label">Start PnL</div>
        <div class="metric-value stat-neutral" id="pnl-start">—</div>
      </div>
      <div class="metric">
        <div class="metric-label">Current PnL</div>
        <div class="metric-value stat-neutral" id="pnl-current">—</div>
      </div>
      <div class="metric">
        <div class="metric-label">Delta</div>
        <div class="metric-value stat-neutral" id="pnl-delta">—</div>
      </div>
      <div class="metric">
        <div class="metric-label">Peak / Trough</div>
        <div class="metric-value" id="pnl-peak-trough">—</div>
      </div>
    </div>

    <!-- Chart -->
    <div class="chart-wrapper">
      <div class="chart-header">
        <div class="chart-title">PnL Over Time</div>
        <div class="chart-range">
          <button class="range-btn" data-range="12">1h</button>
          <button class="range-btn" data-range="72">6h</button>
          <button class="range-btn active" data-range="288">24h</button>
          <button class="range-btn" data-range="0">All</button>
        </div>
      </div>
      <canvas id="pnl-canvas"></canvas>
      <div class="pnl-legend">
        <span><span class="legend-dot" style="background:var(--green)"></span>MM Realized</span>
        <span><span class="legend-dot" style="background:var(--cyan)"></span>Sniper PnL</span>
        <span><span class="legend-dot" style="background:var(--text-0)"></span>Total</span>
      </div>
    </div>
  </div>
</div>

<!-- Tab: Config -->
<div class="tab-content" id="tab-config">
  <div class="config-container" id="config-content">
    <div class="empty-state" style="padding:40px">Loading config...</div>
  </div>
</div>

<script>
// ─────────────────────────────────────────────
// PolyEdge v4 Dashboard — Client
// ─────────────────────────────────────────────

const API_BASE = window.location.origin;
const REFRESH_MS = 5000; // 5 second refresh

// ── State ──
let state = {
  status: null,
  mm: null,
  sniper: null,
  meta: null,
  eventLog: [],
};

// ── Fetch Helpers ──
async function fetchJSON(endpoint) {
  try {
    const resp = await fetch(`${API_BASE}${endpoint}`, { signal: AbortSignal.timeout(4000) });
    if (!resp.ok) return null;
    return await resp.json();
  } catch (e) {
    return null;
  }
}

// ── Formatting ──
function fmt$(v, decimals = 2) {
  if (v == null) return '—';
  const s = v >= 0 ? '' : '-';
  return `${s}$${Math.abs(v).toFixed(decimals)}`;
}
function fmtPct(v) { return v != null ? `${v.toFixed(1)}%` : '—'; }
function fmtTime(secs) {
  if (secs == null) return '—';
  const h = Math.floor(secs / 3600);
  const m = Math.floor((secs % 3600) / 60);
  return h > 0 ? `${h}h ${m}m` : `${m}m`;
}
function fmtPrice(v) { return v != null ? v.toFixed(3) : '—'; }
function fmtShort(s, len = 45) {
  if (!s) return '—';
  return s.length > len ? s.substring(0, len) + '…' : s;
}

function smartName(s, maxLen) {
  if (!s) return '—';
  // Numeric condition IDs → short hash
  if (/^\d{10,}/.test(s)) return '#' + s.substring(0, 6);
  let n = s;
  // Strip question mark and trailing whitespace
  n = n.replace(/\?\s*$/, '');
  // Strip common question prefixes
  n = n.replace(/^Will\s+/i, '');
  n = n.replace(/^New\s+/i, '');
  // Strip articles and filler words
  n = n.replace(/\bthe\s+/gi, '');
  n = n.replace(/\bwin\s+/gi, '');
  n = n.replace(/\bbefore\s+/gi, '');
  n = n.replace(/\breturn\s+/gi, '');
  n = n.replace(/\bcome out\s+/gi, '');
  n = n.replace(/\bbe released\s+/gi, '');
  // Clean double spaces
  n = n.replace(/\s{2,}/g, ' ').trim();
  // Truncate if still too long
  if (maxLen && n.length > maxLen) n = n.substring(0, maxLen) + '…';
  return n;
}
function pnlClass(v) {
  if (v > 0.01) return 'stat-positive';
  if (v < -0.01) return 'stat-negative';
  return 'stat-neutral';
}
function urgencyClass(u) {
  const map = { CRITICAL: 'badge-critical', HIGH: 'badge-high', MEDIUM: 'badge-medium', LOW: 'badge-low' };
  return map[u] || 'badge-low';
}

// ── Update Functions ──

function updateHeader(data) {
  if (!data) return;
  const engines = data.engines || {};
  const mm = engines.market_maker || {};
  const sn = engines.sniper || {};
  const me = engines.meta || {};

  // Mode
  const badge = document.getElementById('mode-badge');
  if (data.mode === 'LIVE') {
    badge.textContent = 'LIVE';
    badge.className = 'mode-badge mode-live';
  } else {
    badge.textContent = 'PAPER';
    badge.className = 'mode-badge mode-paper';
  }

  // Uptime
  document.getElementById('uptime').textContent = fmtTime((data.uptime_hours || 0) * 3600);

  // Status dot
  const dot = document.getElementById('status-dot');
  dot.className = 'status-dot dot-green';

  // PnL
  const mmPnl = (mm.pnl?.realized || 0) + (mm.pnl?.unrealized || 0);
  const snPnl = sn.executor?.total_pnl || 0;
  const totalPnl = mmPnl + snPnl;
  const el = document.getElementById('total-pnl');
  el.textContent = fmt$(totalPnl);
  el.className = 'header-stat-value ' + pnlClass(totalPnl);

  // Exposure
  const mmExp = mm.inventory?.total_exposure || 0;
  const snExp = sn.executor?.total_exposure || 0;
  document.getElementById('total-exposure').textContent = `$${(mmExp + snExp).toFixed(0)} / $500`;

  // Engines count
  let running = 0;
  if (mm.status === 'running') running++;
  if (sn.status === 'running') running++;
  if (me.status === 'running') running++;
  document.getElementById('engine-count').textContent = `${running} / 3`;
}

function updateSystem(data) {
  if (!data) return;
  const engines = data.engines || {};
  const mm = engines.market_maker || {};
  const sn = engines.sniper || {};
  const me = engines.meta || {};

  const mmPnl = (mm.pnl?.realized || 0) + (mm.pnl?.unrealized || 0);
  const snPnl = sn.executor?.total_pnl || 0;
  const totalPnl = mmPnl + snPnl;
  const roi = totalPnl / 5000 * 100;

  document.getElementById('sys-bankroll').textContent = '$5,000';
  const roiEl = document.getElementById('sys-roi');
  roiEl.textContent = fmtPct(roi);
  roiEl.className = 'metric-value ' + pnlClass(roi);

  document.getElementById('sys-mm-status').textContent = mm.status || 'stopped';
  document.getElementById('sys-mm-status').style.color = mm.status === 'running' ? 'var(--green)' : 'var(--text-2)';

  document.getElementById('sys-sniper-status').textContent = sn.status || 'stopped';
  document.getElementById('sys-sniper-status').style.color = sn.status === 'running' ? 'var(--green)' : 'var(--text-2)';

  document.getElementById('sys-meta-next').textContent = me.next_run_in_hours != null ? `${me.next_run_in_hours}h` : '—';
  document.getElementById('sys-clob').textContent = data.mode || '—';
}

function updateMM(mm) {
  if (!mm) return;
  document.getElementById('mm-markets').textContent = mm.active_markets || 0;
  document.getElementById('mm-quotes').textContent = mm.quote_count || 0;
  document.getElementById('mm-fills').textContent = mm.fill_count || 0;

  const realPnl = mm.pnl?.realized || 0;
  const unrealPnl = mm.pnl?.unrealized || 0;

  const realEl = document.getElementById('mm-real-pnl');
  realEl.textContent = fmt$(realPnl);
  realEl.className = 'pnl-bar-value ' + pnlClass(realPnl);

  const unrealEl = document.getElementById('mm-unreal-pnl');
  unrealEl.textContent = fmt$(unrealPnl);
  unrealEl.className = 'pnl-bar-value ' + pnlClass(unrealPnl);

  // Bars (center = 0, max = $50)
  const maxBar = 50;
  const realW = Math.min(Math.abs(realPnl) / maxBar * 50, 50);
  const realBar = document.getElementById('mm-real-bar');
  if (realPnl >= 0) {
    realBar.style.left = '50%'; realBar.style.right = 'auto';
    realBar.style.background = 'var(--green)';
  } else {
    realBar.style.right = '50%'; realBar.style.left = 'auto';
    realBar.style.background = 'var(--red)';
  }
  realBar.style.width = realW + '%';

  const unrealW = Math.min(Math.abs(unrealPnl) / maxBar * 50, 50);
  const unrealBar = document.getElementById('mm-unreal-bar');
  if (unrealPnl >= 0) {
    unrealBar.style.left = '50%'; unrealBar.style.right = 'auto';
    unrealBar.style.background = 'var(--green)';
  } else {
    unrealBar.style.right = '50%'; unrealBar.style.left = 'auto';
    unrealBar.style.background = 'var(--amber)';
  }
  unrealBar.style.width = unrealW + '%';

  // Kill switch
  const ks = document.getElementById('mm-kill-switch');
  ks.style.display = (mm.kill_switch || mm.inventory?.kill_switch) ? 'block' : 'none';

  // Quote table
  let quotesArr = mm.active_quotes || [];
  if (mm.quotes && typeof mm.quotes === 'object' && !Array.isArray(mm.quotes)) {
    quotesArr = Object.entries(mm.quotes).map(([tid, q]) => ({
      condition_id: tid,
      bid_price: q.bid ? parseFloat(q.bid.split('x')[0]) : null,
      ask_price: q.ask ? parseFloat(q.ask.split('x')[0]) : null,
      bid_size: q.bid ? parseFloat(q.bid.split('x')[1]) : 0,
      ask_size: q.ask ? parseFloat(q.ask.split('x')[1]) : 0,
      spread: q.bid && q.ask ? parseFloat(q.ask.split('x')[0]) - parseFloat(q.bid.split('x')[0]) : null,
      fair_value: q.fair_value,
      market: q.question || tid,
      url: q.url || '',
    }));
  }
  updateQuotes(quotesArr);

  const tokenNames = {};
  if (mm.quotes && typeof mm.quotes === 'object') {
    Object.entries(mm.quotes).forEach(([tid, q]) => {
      if (q.question) tokenNames[tid] = q.question;
      if (q.url) tokenNames[tid + '_url'] = q.url;
    });
  }
  if (mm.token_names && typeof mm.token_names === 'object') {
    Object.entries(mm.token_names).forEach(([tid, info]) => {
      if (info.question && !tokenNames[tid]) tokenNames[tid] = info.question;
      if (info.url && !tokenNames[tid + '_url']) tokenNames[tid + '_url'] = info.url;
    });
  }
  if (mm.markets && Array.isArray(mm.markets)) {
    mm.markets.forEach(m => {
      if (m.question && m.token_id) tokenNames[m.token_id] = m.question;
    });
  }
  updateInventory(mm.inventory?.positions || {}, tokenNames);
}

function updateQuotes(quotes) {
  const tbody = document.getElementById('quote-tbody');
  if (!quotes || quotes.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No active quotes</td></tr>';
    return;
  }
  tbody.innerHTML = quotes.map(q => {
    const fullName = q.market || q.condition_id || '—';
    const shortLabel = smartName(fullName, 38);
    const label = q.url
      ? `<a href="${q.url}" target="_blank" class="quote-market-link" title="${fullName}">${shortLabel}</a>`
      : `<span title="${fullName}">${shortLabel}</span>`;
    return `
    <tr>
      <td class="quote-market-cell">${label}</td>
      <td style="color:var(--green)">${fmtPrice(q.bid_price)}</td>
      <td style="color:var(--red)">${fmtPrice(q.ask_price)}</td>
      <td style="color:var(--amber)">${q.spread ? (q.spread * 100).toFixed(1) + '¢' : '—'}</td>
      <td>$${(q.bid_size || 0).toFixed(0)}</td>
      <td style="color:var(--cyan)">${fmtPrice(q.fair_value)}</td>
    </tr>
  `}).join('');
}

function updateInventory(positions, tokenNames) {
  tokenNames = tokenNames || {};
  const panel = document.getElementById('inventory-panel');
  if (!positions || Object.keys(positions).length === 0) {
    panel.innerHTML = '<div class="empty-state">No positions</div>';
    return;
  }

  const maxPos = 50;
  panel.innerHTML = Object.entries(positions).map(([market, pos]) => {
    const net = pos.net_position || pos.net || 0;
    const tid = pos.token_id || market;
    const fullName = tokenNames[tid] || tokenNames[market] || market;
    const shortLabel = smartName(fullName);
    const url = tokenNames[tid + '_url'] || tokenNames[market + '_url'] || '';
    const pct = Math.min(Math.abs(net) / maxPos * 50, 50);
    const isLong = net > 0;
    const label = url
      ? `<a href="${url}" target="_blank" class="inv-link" title="${fullName}">${shortLabel}</a>`
      : `<span title="${fullName}">${shortLabel}</span>`;
    return `
      <div class="inv-row">
        <span class="inv-label">${label}</span>
        <div class="inv-track">
          <div class="inv-center"></div>
          ${isLong
            ? `<div class="inv-fill-long" style="width:${pct}%"></div>`
            : `<div class="inv-fill-short" style="width:${pct}%"></div>`
          }
        </div>
        <span class="inv-value" style="color:${isLong ? 'var(--green)' : 'var(--red)'}">
          ${net >= 0 ? '+' : ''}${net.toFixed(1)}
        </span>
      </div>
    `;
  }).join('');
}

function updateSniper(sn) {
  if (!sn) return;
  const exec = sn.executor || {};
  document.getElementById('sniper-trades').textContent = sn.trades_executed || 0;
  document.getElementById('sniper-winrate').textContent = fmtPct(exec.win_rate || 0);

  const posDiv = document.getElementById('sniper-positions');
  const positions = exec.active_positions || [];
  if (positions.length === 0) {
    posDiv.innerHTML = '<div style="font-size:11px;color:var(--text-2);text-align:center;padding:8px">No active sniper positions</div>';
    return;
  }

  posDiv.innerHTML = positions.map(p => `
    <div class="signal-row ${p.direction === 'BUY' ? 'signal-buy' : 'signal-sell'}">
      <div class="signal-info">
        <div class="signal-market">${fmtShort(p.market, 40)}</div>
        <div class="signal-detail">${p.direction} $${p.size?.toFixed(0)} @ ${p.entry?.toFixed(3)} · edge ${p.edge}%</div>
      </div>
      <span style="font-size:11px;color:var(--text-2)">${p.age_s}s</span>
    </div>
  `).join('');
}

function updateGapRadar(sn) {
  if (!sn) return;
  const signals = sn.recent_signals || [];
  const panel = document.getElementById('gap-panel');

  if (signals.length === 0) {
    panel.innerHTML = '<div class="empty-state">No gap signals detected</div>';
    return;
  }

  panel.innerHTML = signals.map(s => `
    <div class="signal-row ${s.direction === 'BUY' ? 'signal-buy' : 'signal-sell'}">
      <div class="signal-info">
        <div class="signal-market">${fmtShort(s.market, 50)}</div>
        <div class="signal-detail">${s.trigger} · ${s.gap_cents?.toFixed(1)}¢ gap · ${s.reasoning}</div>
      </div>
      <span class="signal-badge ${urgencyClass(s.urgency)}">${s.urgency}</span>
      <span style="font-size:13px;font-weight:600;color:${s.direction === 'BUY' ? 'var(--green)' : 'var(--red)'}">
        ${s.edge_pct?.toFixed(1)}%
      </span>
    </div>
  `).join('');
}

function updateEventLog(sn) {
  if (!sn) return;
  const events = sn.recent_signals || [];
  const log = document.getElementById('event-log');

  if (events.length === 0 && state.eventLog.length === 0) {
    log.innerHTML = '<div class="empty-state">No events yet</div>';
    return;
  }

  events.forEach(e => {
    const key = `${e.trigger}-${e.market?.substring(0,20)}`;
    if (!state.eventLog.find(x => x.key === key)) {
      state.eventLog.unshift({
        key,
        time: new Date(),
        type: e.trigger,
        msg: `${e.direction} ${e.gap_cents?.toFixed(1)}¢ gap on ${fmtShort(e.market, 40)}`,
        color: e.direction === 'BUY' ? 'var(--green)' : 'var(--red)',
      });
    }
  });

  state.eventLog = state.eventLog.slice(0, 50);

  log.innerHTML = state.eventLog.map(e => {
    const t = e.time;
    const ts = `${String(t.getHours()).padStart(2,'0')}:${String(t.getMinutes()).padStart(2,'0')}`;
    return `
      <div class="log-entry">
        <span class="log-time">${ts}</span>
        <span class="log-type" style="color:${e.color || 'var(--text-1)'}">${e.type}</span>
        <span class="log-msg">${e.msg}</span>
      </div>
    `;
  }).join('');
}

function updateFeeds(data) {
  if (!data) return;
  const feeds = data.feeds || data.orderbook_ws || {};

  const dot = document.getElementById('ws-dot');
  const statusText = document.getElementById('ws-status-text');
  if (feeds.connected) {
    dot.className = 'status-dot dot-green';
    statusText.textContent = 'connected';
    statusText.style.color = 'var(--green)';
  } else {
    dot.className = 'status-dot dot-red';
    statusText.textContent = 'disconnected';
    statusText.style.color = 'var(--red)';
  }

  document.getElementById('ws-subscribed').textContent = feeds.subscribed || 0;

  const hitRate = feeds.ws_hit_rate;
  const hitEl = document.getElementById('ws-hit-rate');
  if (hitRate != null) {
    hitEl.textContent = hitRate.toFixed(1) + '%';
    hitEl.style.color = hitRate >= 80 ? 'var(--green)' : hitRate >= 50 ? 'var(--amber)' : 'var(--red)';
  } else {
    hitEl.textContent = '—';
    hitEl.style.color = 'var(--text-1)';
  }

  const age = feeds.last_msg_age_s;
  const ageEl = document.getElementById('ws-last-msg');
  if (age != null) {
    ageEl.textContent = age < 60 ? age.toFixed(0) + 's' : fmtTime(age);
    ageEl.style.color = age <= 30 ? 'var(--green)' : age <= 60 ? 'var(--amber)' : 'var(--red)';
  } else {
    ageEl.textContent = '—';
    ageEl.style.color = 'var(--text-2)';
  }

  const reconEl = document.getElementById('ws-reconnects');
  reconEl.textContent = feeds.reconnects || 0;
  reconEl.style.color = (feeds.reconnects || 0) > 5 ? 'var(--amber)' : 'var(--text-0)';

  document.getElementById('ws-book-updates').textContent = feeds.book_updates || 0;
}

function updateMeta(meta) {
  if (!meta) return;
  document.getElementById('meta-runs').textContent = meta.run_count || 0;
  document.getElementById('meta-cost').textContent = fmt$(meta.total_llm_cost || 0, 4);

  const adjs = meta.adjustment_history || [];
  document.getElementById('meta-adjustments').textContent = adjs.length;
  document.getElementById('meta-next-run').textContent =
    meta.next_run_in_hours != null ? `${meta.next_run_in_hours}h` : '—';

  const reportsDiv = document.getElementById('meta-reports');
  const reports = meta.recent_reports || [];

  if (reports.length === 0) {
    reportsDiv.innerHTML = '<div class="empty-state">No reports yet (first run after 1h)</div>';
    return;
  }

  reportsDiv.innerHTML = reports.reverse().map(r => `
    <div class="meta-card">
      <div class="meta-card-title">${r.time} · PnL ${fmt$(r.total_pnl)} · ${r.adjustments} adj · ${fmt$(r.cost, 4)} cost</div>
      <div class="meta-card-text">${r.summary}</div>
    </div>
  `).join('');

  if (adjs.length > 0) {
    reportsDiv.innerHTML += '<div style="margin-top:12px">' +
      adjs.slice(-5).reverse().map(a => `
        <div class="adj-row">
          <span class="adj-engine">${a.engine?.toUpperCase()}</span>
          <span class="adj-param">${a.parameter}</span>
          <span class="adj-change">${a.old_value} → ${a.new_value}</span>
        </div>
      `).join('') + '</div>';
  }
}

// ─────────────────────────────────────────────
// Tab Navigation
// ─────────────────────────────────────────────

let activeTab = 'dashboard';
let tradesSortField = 'pnl';
let tradesSortAsc = false;
let pnlRange = 288;
let pnlData = null;
let configLoaded = false;

document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const tab = btn.dataset.tab;
    if (tab === activeTab) return;

    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.getElementById('tab-' + tab).classList.add('active');

    activeTab = tab;

    if (tab === 'trades') refreshTrades();
    if (tab === 'pnl') refreshPnl();
    if (tab === 'config' && !configLoaded) refreshConfig();
  });
});

// Range buttons
document.querySelectorAll('.range-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    pnlRange = parseInt(btn.dataset.range);
    refreshPnl();
  });
});

// Sort headers
document.querySelectorAll('.trades-table th[data-sort]').forEach(th => {
  th.addEventListener('click', () => {
    const field = th.dataset.sort;
    if (tradesSortField === field) {
      tradesSortAsc = !tradesSortAsc;
    } else {
      tradesSortField = field;
      tradesSortAsc = false;
    }
    renderCompletedTrades(state.trades?.completed || []);
  });
});

// ─────────────────────────────────────────────
// Trades Tab
// ─────────────────────────────────────────────

async function refreshTrades() {
  const data = await fetchJSON('/api/trades');
  if (!data) return;
  state.trades = data;

  const s = data.summary || {};
  document.getElementById('trades-total').textContent = s.total_trades || 0;
  const wr = document.getElementById('trades-winrate');
  wr.textContent = fmtPct(s.win_rate || 0);
  wr.className = 'metric-value ' + ((s.win_rate || 0) >= 50 ? 'stat-positive' : 'stat-neutral');

  const pEl = document.getElementById('trades-pnl');
  pEl.textContent = fmt$(s.total_pnl);
  pEl.className = 'metric-value ' + pnlClass(s.total_pnl || 0);

  const aEl = document.getElementById('trades-avg');
  aEl.textContent = fmt$(s.avg_pnl);
  aEl.className = 'metric-value ' + pnlClass(s.avg_pnl || 0);

  const activeTbody = document.getElementById('trades-active-tbody');
  const active = data.active || [];
  if (active.length === 0) {
    activeTbody.innerHTML = '<tr><td colspan="6" class="empty-state">No active positions</td></tr>';
  } else {
    activeTbody.innerHTML = active.map(p => `
      <tr>
        <td style="max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${fmtShort(p.market, 50)}</td>
        <td style="color:${p.direction === 'BUY' ? 'var(--green)' : 'var(--red)'}">${p.direction}</td>
        <td>$${(p.size || 0).toFixed(0)}</td>
        <td>${fmtPrice(p.entry)}</td>
        <td>${(p.edge || 0).toFixed(1)}%</td>
        <td style="color:var(--text-2)">${(p.age_s || 0).toFixed(0)}s</td>
      </tr>
    `).join('');
  }

  renderCompletedTrades(data.completed || []);
}

function renderCompletedTrades(trades) {
  const tbody = document.getElementById('trades-completed-tbody');
  document.getElementById('trades-completed-count').textContent = `(${trades.length})`;

  if (trades.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No completed trades</td></tr>';
    return;
  }

  const sorted = [...trades].sort((a, b) => {
    let va = a[tradesSortField], vb = b[tradesSortField];
    if (tradesSortField === 'market' || tradesSortField === 'market_question') {
      va = (a.market_question || '').toLowerCase();
      vb = (b.market_question || '').toLowerCase();
    }
    if (typeof va === 'string') return tradesSortAsc ? va.localeCompare(vb) : vb.localeCompare(va);
    return tradesSortAsc ? (va || 0) - (vb || 0) : (vb || 0) - (va || 0);
  });

  tbody.innerHTML = sorted.map(t => {
    const pnl = t.pnl || 0;
    return `
      <tr>
        <td style="max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${t.market_question || ''}">${fmtShort(t.market_question, 50)}</td>
        <td style="color:${t.direction === 'BUY' ? 'var(--green)' : 'var(--red)'}">${t.direction || '—'}</td>
        <td>$${(t.size || 0).toFixed(0)}</td>
        <td>${fmtPrice(t.entry_price)}</td>
        <td>${fmtPrice(t.fill_price)}</td>
        <td style="color:${pnl > 0 ? 'var(--green)' : pnl < 0 ? 'var(--red)' : 'var(--text-1)'};font-weight:600">${fmt$(pnl)}</td>
        <td style="color:var(--text-2)">${t.status || '—'}</td>
      </tr>
    `;
  }).join('');
}

// ─────────────────────────────────────────────
// PnL Chart Tab
// ─────────────────────────────────────────────

async function refreshPnl() {
  const n = pnlRange || 9999;
  const data = await fetchJSON(`/api/history?n=${n}`);
  if (!data || data.length === 0) {
    document.getElementById('pnl-start').textContent = '—';
    document.getElementById('pnl-current').textContent = '—';
    document.getElementById('pnl-delta').textContent = '—';
    document.getElementById('pnl-peak-trough').textContent = '—';
    return;
  }
  pnlData = data;

  const totals = data.map(d => (d.mm_realized || 0) + (d.mm_unrealized || 0) + (d.sniper_pnl || 0));
  const first = totals[0];
  const last = totals[totals.length - 1];
  const delta = last - first;
  const peak = Math.max(...totals);
  const trough = Math.min(...totals);

  const startEl = document.getElementById('pnl-start');
  startEl.textContent = fmt$(first);
  startEl.className = 'metric-value ' + pnlClass(first);

  const curEl = document.getElementById('pnl-current');
  curEl.textContent = fmt$(last);
  curEl.className = 'metric-value ' + pnlClass(last);

  const deltaEl = document.getElementById('pnl-delta');
  deltaEl.textContent = (delta >= 0 ? '+' : '') + fmt$(delta);
  deltaEl.className = 'metric-value ' + pnlClass(delta);

  const ptEl = document.getElementById('pnl-peak-trough');
  ptEl.innerHTML = `<span style="color:var(--green)">${fmt$(peak)}</span> / <span style="color:var(--red)">${fmt$(trough)}</span>`;

  drawPnlChart(data);
}

function drawPnlChart(data) {
  const canvas = document.getElementById('pnl-canvas');
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  const ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);

  const W = rect.width;
  const H = rect.height;
  const pad = { top: 20, right: 60, bottom: 30, left: 10 };
  const chartW = W - pad.left - pad.right;
  const chartH = H - pad.top - pad.bottom;

  ctx.clearRect(0, 0, W, H);

  if (data.length < 2) return;

  const mmSeries = data.map(d => d.mm_realized || 0);
  const snSeries = data.map(d => d.sniper_pnl || 0);
  const totalSeries = data.map(d => (d.mm_realized || 0) + (d.mm_unrealized || 0) + (d.sniper_pnl || 0));

  const allVals = [...mmSeries, ...snSeries, ...totalSeries];
  let minVal = Math.min(...allVals);
  let maxVal = Math.max(...allVals);
  if (maxVal === minVal) { maxVal += 1; minVal -= 1; }
  const range = maxVal - minVal;

  function xPos(i) { return pad.left + (i / (data.length - 1)) * chartW; }
  function yPos(v) { return pad.top + (1 - (v - minVal) / range) * chartH; }

  // Grid lines
  ctx.strokeStyle = 'rgba(0,180,216,0.08)';
  ctx.lineWidth = 0.5;
  const gridLines = 5;
  for (let i = 0; i <= gridLines; i++) {
    const y = pad.top + (i / gridLines) * chartH;
    ctx.beginPath();
    ctx.moveTo(pad.left, y);
    ctx.lineTo(W - pad.right, y);
    ctx.stroke();

    const val = maxVal - (i / gridLines) * range;
    ctx.fillStyle = '#4a6a8a';
    ctx.font = '10px Fira Code';
    ctx.textAlign = 'left';
    ctx.fillText(fmt$(val), W - pad.right + 6, y + 3);
  }

  // Zero line
  if (minVal < 0 && maxVal > 0) {
    const zeroY = yPos(0);
    ctx.strokeStyle = 'rgba(0,180,216,0.2)';
    ctx.lineWidth = 1;
    ctx.setLineDash([4, 4]);
    ctx.beginPath();
    ctx.moveTo(pad.left, zeroY);
    ctx.lineTo(W - pad.right, zeroY);
    ctx.stroke();
    ctx.setLineDash([]);
  }

  // Time labels
  ctx.fillStyle = '#4a6a8a';
  ctx.font = '10px Fira Code';
  ctx.textAlign = 'center';
  const labelCount = Math.min(6, data.length);
  for (let i = 0; i < labelCount; i++) {
    const idx = Math.floor(i / (labelCount - 1) * (data.length - 1));
    const ts = data[idx]._ts;
    if (ts) {
      const d = new Date(ts);
      const lbl = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
      ctx.fillText(lbl, xPos(idx), H - 6);
    }
  }

  function drawLine(series, color, width) {
    ctx.strokeStyle = color;
    ctx.lineWidth = width;
    ctx.lineJoin = 'round';
    ctx.beginPath();
    for (let i = 0; i < series.length; i++) {
      const x = xPos(i);
      const y = yPos(series[i]);
      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    }
    ctx.stroke();

    // Glow effect
    ctx.save();
    ctx.globalAlpha = 0.15;
    ctx.strokeStyle = color;
    ctx.lineWidth = width + 4;
    ctx.filter = 'blur(4px)';
    ctx.beginPath();
    for (let i = 0; i < series.length; i++) {
      const x = xPos(i);
      const y = yPos(series[i]);
      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    }
    ctx.stroke();
    ctx.restore();
  }

  drawLine(mmSeries, '#06d6a0', 1.5);
  drawLine(snSeries, '#00b4d8', 1.5);
  drawLine(totalSeries, '#e4eef8', 2);
}

window.addEventListener('resize', () => {
  if (activeTab === 'pnl' && pnlData) drawPnlChart(pnlData);
});

// ─────────────────────────────────────────────
// Config Tab
// ─────────────────────────────────────────────

async function refreshConfig() {
  const data = await fetchJSON('/api/config');
  if (!data) return;
  configLoaded = true;

  const container = document.getElementById('config-content');

  const s = data.structured;
  if (s) {
    container.innerHTML = `
      <div class="config-section">
        <div class="config-section-header">System</div>
        <div class="config-row"><span class="config-key">Mode</span><span class="config-val" style="color:${s.mode === 'PAPER' ? 'var(--amber)' : 'var(--red)'}">${s.mode}</span></div>
        <div class="config-row"><span class="config-key">Bankroll</span><span class="config-val">$${(s.bankroll || 0).toLocaleString()}</span></div>
      </div>

      <div class="config-section">
        <div class="config-section-header">Market Maker</div>
        ${s.mm ? Object.entries(s.mm).map(([k, v]) => `
          <div class="config-row">
            <span class="config-key">${k.replace(/_/g, ' ')}</span>
            <span class="config-val">${typeof v === 'number' && k.includes('spread') ? (v * 100).toFixed(1) + '¢' : typeof v === 'number' && (k.includes('position') || k.includes('inventory') || k.includes('loss')) ? '$' + v : v}</span>
          </div>
        `).join('') : ''}
      </div>

      <div class="config-section">
        <div class="config-section-header">Sniper</div>
        ${s.sniper ? Object.entries(s.sniper).map(([k, v]) => `
          <div class="config-row">
            <span class="config-key">${k.replace(/_/g, ' ')}</span>
            <span class="config-val">${typeof v === 'number' && (k.includes('size') || k.includes('exposure')) ? '$' + v : typeof v === 'number' && k.includes('pct') ? v + '%' : typeof v === 'number' && k.includes('cents') ? v + '¢' : v}</span>
          </div>
        `).join('') : ''}
      </div>

      <div class="config-section">
        <div class="config-section-header">Meta Strategist</div>
        ${s.meta ? Object.entries(s.meta).map(([k, v]) => `
          <div class="config-row">
            <span class="config-key">${k.replace(/_/g, ' ')}</span>
            <span class="config-val">${k === 'auto_apply' ? (v ? '<span style="color:var(--green)">ON</span>' : '<span style="color:var(--red)">OFF</span>') : k.includes('hours') ? v + 'h' : v}</span>
          </div>
        `).join('') : ''}
      </div>
    `;
  } else {
    container.innerHTML = `
      <div class="config-section">
        <div class="config-section-header">Configuration</div>
        <pre style="padding:14px;font-size:12px;color:var(--text-1);white-space:pre-wrap;line-height:1.8">${data.text || data.config || 'No config available'}</pre>
      </div>
    `;
  }
}

// ── Main Refresh Loop ──
async function refresh() {
  const statusData = await fetchJSON('/api/status');
  state.status = statusData;
  updateHeader(statusData);

  if (activeTab === 'dashboard') {
    const [mmData, sniperData, metaData] = await Promise.all([
      fetchJSON('/api/mm'),
      fetchJSON('/api/sniper'),
      fetchJSON('/api/meta'),
    ]);

    state.mm = mmData;
    state.sniper = sniperData;
    state.meta = metaData;

    updateSystem(statusData);
    updateFeeds(statusData);
    updateMM(mmData);
    updateSniper(sniperData);
    updateGapRadar(sniperData);
    updateEventLog(sniperData);
    updateMeta(metaData);
  } else if (activeTab === 'trades') {
    refreshTrades();
  } else if (activeTab === 'pnl') {
    refreshPnl();
  }
}

// Start
refresh();
setInterval(refresh, REFRESH_MS);

console.log('PolyEdge v4 Dashboard initialized — refreshing every 5s');
</script>
</body>
</html>
