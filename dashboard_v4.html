<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PolyEdge v4 — Command Center</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
/* ═══════════════════════════════════════════════
   POLYEDGE v4 — OBSIDIAN TERMINAL
   A luxury trading command center
   ═══════════════════════════════════════════════ */

:root {
  /* Obsidian palette */
  --ob-void: #08080a;
  --ob-deep: #0c0c10;
  --ob-base: #111116;
  --ob-layer: #16161d;
  --ob-raised: #1c1c25;
  --ob-surface: #22222e;

  /* Borders & lines */
  --line-faint: rgba(255,255,255,0.04);
  --line-soft: rgba(255,255,255,0.07);
  --line-medium: rgba(255,255,255,0.12);

  /* Text hierarchy */
  --ink-primary: #e8e6e1;
  --ink-secondary: #9e9a90;
  --ink-tertiary: #5e5b54;
  --ink-ghost: #3a3834;

  /* Signal colors — warm palette */
  --signal-profit: #a8c686;
  --signal-profit-bright: #c4e89e;
  --signal-loss: #c67a6e;
  --signal-loss-bright: #e69888;
  --signal-warn: #d4a747;
  --signal-warn-bright: #f0c05a;
  --signal-info: #7a9ec6;
  --signal-info-bright: #94b8e0;

  /* Accent — warm gold */
  --accent: #c9a84c;
  --accent-dim: #a08338;
  --accent-glow: rgba(201,168,76,0.08);
  --accent-border: rgba(201,168,76,0.2);

  /* Typography */
  --font-data: 'DM Mono', 'Menlo', monospace;
  --font-display: 'Outfit', sans-serif;

  /* Geometry */
  --radius-sm: 2px;
  --radius-md: 6px;
  --radius-lg: 10px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

html { scroll-behavior: smooth; }

body {
  background: var(--ob-void);
  color: var(--ink-primary);
  font-family: var(--font-data);
  font-size: 12.5px;
  line-height: 1.55;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* Atmospheric background texture */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background:
    radial-gradient(ellipse 80% 50% at 20% 0%, rgba(201,168,76,0.03) 0%, transparent 70%),
    radial-gradient(ellipse 60% 40% at 80% 100%, rgba(122,158,198,0.02) 0%, transparent 60%);
  pointer-events: none;
  z-index: 0;
}

/* Fine grain overlay */
body::after {
  content: '';
  position: fixed;
  inset: 0;
  opacity: 0.015;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  background-size: 256px 256px;
  pointer-events: none;
  z-index: 0;
}

/* Selections */
::selection { background: rgba(201,168,76,0.25); color: var(--ink-primary); }

/* Scrollbars */
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--line-medium); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.18); }

/* ─── HEADER ─── */
.header {
  position: sticky;
  top: 0;
  z-index: 100;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 28px;
  height: 56px;
  background: var(--ob-deep);
  border-bottom: 1px solid var(--line-soft);
  backdrop-filter: blur(20px);
}

.header-left {
  display: flex;
  align-items: center;
  gap: 20px;
}

.logo {
  font-family: var(--font-display);
  font-weight: 800;
  font-size: 20px;
  letter-spacing: -0.8px;
  color: var(--ink-primary);
  display: flex;
  align-items: baseline;
  gap: 4px;
}
.logo-mark {
  color: var(--accent);
}
.logo-version {
  font-family: var(--font-data);
  font-weight: 300;
  font-size: 10px;
  color: var(--ink-tertiary);
  margin-left: 8px;
  padding: 2px 6px;
  border: 1px solid var(--line-soft);
  border-radius: var(--radius-sm);
  letter-spacing: 0.5px;
}

.mode-badge {
  padding: 4px 12px;
  font-family: var(--font-data);
  font-size: 10px;
  font-weight: 500;
  letter-spacing: 2px;
  border-radius: var(--radius-sm);
  text-transform: uppercase;
}
.mode-paper {
  background: rgba(212,167,71,0.08);
  color: var(--signal-warn);
  border: 1px solid rgba(212,167,71,0.2);
}
.mode-live {
  background: rgba(198,122,110,0.1);
  color: var(--signal-loss-bright);
  border: 1px solid rgba(198,122,110,0.25);
  animation: live-pulse 3s ease-in-out infinite;
}
@keyframes live-pulse {
  0%, 100% { border-color: rgba(198,122,110,0.25); }
  50% { border-color: rgba(198,122,110,0.5); }
}

.uptime-cluster {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 11px;
  color: var(--ink-tertiary);
}
.status-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  animation: dot-breathe 3s ease-in-out infinite;
}
.dot-green { background: var(--signal-profit); box-shadow: 0 0 8px rgba(168,198,134,0.4); }
.dot-red { background: var(--signal-loss); box-shadow: 0 0 8px rgba(198,122,110,0.4); }
.dot-amber { background: var(--signal-warn); box-shadow: 0 0 8px rgba(212,167,71,0.4); }
@keyframes dot-breathe {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.5; transform: scale(0.85); }
}

.header-right {
  display: flex;
  align-items: center;
  gap: 32px;
}

.header-stat {
  text-align: right;
}
.header-stat-label {
  font-size: 9px;
  color: var(--ink-ghost);
  text-transform: uppercase;
  letter-spacing: 1.5px;
  font-weight: 400;
  margin-bottom: 2px;
}
.header-stat-value {
  font-family: var(--font-display);
  font-size: 17px;
  font-weight: 600;
  letter-spacing: -0.3px;
}
.stat-positive { color: var(--signal-profit-bright); }
.stat-negative { color: var(--signal-loss-bright); }
.stat-neutral { color: var(--ink-secondary); }

/* Divider between header stats */
.header-divider {
  width: 1px;
  height: 28px;
  background: var(--line-faint);
}

/* ─── GRID ─── */
.grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  grid-template-rows: auto auto auto;
  gap: 1px;
  padding: 0;
  background: var(--line-faint);
  min-height: calc(100vh - 56px);
  position: relative;
  z-index: 1;
}

/* ─── PANEL ─── */
.panel {
  background: var(--ob-base);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  position: relative;
}

.panel::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent 0%, var(--line-medium) 50%, transparent 100%);
  opacity: 0;
  transition: opacity 0.4s ease;
}
.panel:hover::before { opacity: 1; }

.panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 18px;
  background: var(--ob-layer);
  border-bottom: 1px solid var(--line-faint);
  min-height: 42px;
}

.panel-title {
  font-family: var(--font-display);
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--ink-secondary);
}

.panel-tag {
  font-family: var(--font-data);
  font-size: 9px;
  font-weight: 400;
  padding: 3px 8px;
  border-radius: var(--radius-sm);
  letter-spacing: 0.8px;
  text-transform: uppercase;
}
.tag-engine { background: rgba(201,168,76,0.06); color: var(--accent); border: 1px solid rgba(201,168,76,0.12); }
.tag-feed { background: rgba(122,158,198,0.06); color: var(--signal-info); border: 1px solid rgba(122,158,198,0.12); }
.tag-meta { background: rgba(168,198,134,0.06); color: var(--signal-profit); border: 1px solid rgba(168,198,134,0.12); }
.tag-risk { background: rgba(198,122,110,0.06); color: var(--signal-loss); border: 1px solid rgba(198,122,110,0.12); }

.panel-body {
  flex: 1;
  padding: 16px 18px;
  overflow-y: auto;
}

/* Column spans */
.span-2 { grid-column: span 2; }
.span-3 { grid-column: span 3; }
.span-4 { grid-column: span 4; }

/* ─── METRIC GRID ─── */
.metrics {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 6px;
}
.metrics-3 { grid-template-columns: repeat(3, 1fr); }

.metric {
  background: var(--ob-layer);
  border: 1px solid var(--line-faint);
  border-radius: var(--radius-md);
  padding: 12px 14px;
  transition: border-color 0.3s ease, background 0.3s ease;
}
.metric:hover {
  border-color: var(--line-medium);
  background: var(--ob-raised);
}

.metric-label {
  font-size: 9px;
  color: var(--ink-ghost);
  text-transform: uppercase;
  letter-spacing: 1.2px;
  margin-bottom: 6px;
  font-weight: 400;
}
.metric-value {
  font-family: var(--font-display);
  font-size: 20px;
  font-weight: 600;
  letter-spacing: -0.5px;
  color: var(--ink-primary);
}

/* ─── DATA TABLE ─── */
.dtable { width: 100%; border-collapse: collapse; }
.dtable th {
  text-align: left;
  font-size: 9px;
  font-weight: 400;
  color: var(--ink-ghost);
  text-transform: uppercase;
  letter-spacing: 1px;
  padding: 0 0 10px 0;
  border-bottom: 1px solid var(--line-soft);
}
.dtable td {
  padding: 8px 0;
  border-bottom: 1px solid var(--line-faint);
  font-size: 12px;
  color: var(--ink-secondary);
  transition: color 0.2s ease;
}
.dtable tr { transition: background 0.2s ease; }
.dtable tr:hover td {
  background: var(--accent-glow);
  color: var(--ink-primary);
}

/* ─── PNL BARS ─── */
.pnl-bar {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
}
.pnl-bar-label {
  font-size: 10px;
  color: var(--ink-tertiary);
  width: 42px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.pnl-bar-track {
  flex: 1;
  height: 20px;
  background: var(--ob-void);
  border-radius: var(--radius-sm);
  overflow: hidden;
  position: relative;
  border: 1px solid var(--line-faint);
}
.pnl-bar-fill {
  height: 100%;
  border-radius: var(--radius-sm);
  transition: width 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  position: absolute;
  opacity: 0.7;
}
.pnl-bar-value {
  font-size: 11px;
  font-weight: 500;
  width: 60px;
  text-align: right;
  font-family: var(--font-data);
}

/* ─── SIGNAL ROWS ─── */
.signal-row {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 12px;
  border-radius: var(--radius-md);
  margin-bottom: 4px;
  background: var(--ob-layer);
  border-left: 2px solid transparent;
  transition: all 0.25s ease;
  border: 1px solid var(--line-faint);
  border-left-width: 2px;
}
.signal-row:hover {
  background: var(--ob-raised);
  transform: translateX(2px);
}
.signal-buy { border-left-color: var(--signal-profit); }
.signal-sell { border-left-color: var(--signal-loss); }
.signal-info { flex: 1; min-width: 0; }
.signal-market {
  font-size: 11px;
  color: var(--ink-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-weight: 400;
}
.signal-detail {
  font-size: 10px;
  color: var(--ink-tertiary);
  margin-top: 3px;
  letter-spacing: 0.2px;
}
.signal-badge {
  font-size: 9px;
  padding: 3px 8px;
  border-radius: var(--radius-sm);
  font-weight: 500;
  white-space: nowrap;
  letter-spacing: 0.8px;
  text-transform: uppercase;
}
.badge-critical { background: rgba(198,122,110,0.12); color: var(--signal-loss-bright); border: 1px solid rgba(198,122,110,0.2); }
.badge-high { background: rgba(212,167,71,0.12); color: var(--signal-warn-bright); border: 1px solid rgba(212,167,71,0.2); }
.badge-medium { background: rgba(122,158,198,0.12); color: var(--signal-info-bright); border: 1px solid rgba(122,158,198,0.2); }
.badge-low { background: rgba(255,255,255,0.03); color: var(--ink-tertiary); border: 1px solid var(--line-faint); }

/* ─── INVENTORY BARS ─── */
.inv-row {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}
.inv-label {
  font-size: 11px;
  min-width: 180px;
  max-width: 220px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  color: var(--ink-secondary);
}
.inv-label a { color: inherit; text-decoration: none; transition: color 0.2s; }
.inv-label a:hover { color: var(--accent); }

.inv-track {
  flex: 1;
  height: 22px;
  background: var(--ob-void);
  border-radius: var(--radius-sm);
  position: relative;
  overflow: hidden;
  border: 1px solid var(--line-faint);
}
.inv-fill-long, .inv-fill-short {
  position: absolute;
  height: 100%;
  top: 0;
  transition: width 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}
.inv-fill-long {
  left: 50%;
  background: linear-gradient(90deg, var(--signal-profit), rgba(168,198,134,0.3));
  opacity: 0.55;
  border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
}
.inv-fill-short {
  right: 50%;
  background: linear-gradient(270deg, var(--signal-loss), rgba(198,122,110,0.3));
  opacity: 0.55;
  border-radius: var(--radius-sm) 0 0 var(--radius-sm);
}
.inv-center {
  position: absolute;
  left: 50%;
  top: 0;
  bottom: 0;
  width: 1px;
  background: var(--ink-ghost);
}
.inv-value {
  font-size: 11px;
  width: 50px;
  text-align: right;
  font-weight: 500;
  font-family: var(--font-data);
}

/* ─── EVENT LOG ─── */
.log-entry {
  display: flex;
  gap: 10px;
  padding: 6px 0;
  border-bottom: 1px solid var(--line-faint);
  font-size: 11px;
  transition: background 0.2s ease;
}
.log-entry:hover { background: var(--accent-glow); }
.log-time {
  color: var(--ink-ghost);
  white-space: nowrap;
  width: 48px;
  flex-shrink: 0;
  font-size: 10px;
  letter-spacing: 0.5px;
}
.log-type {
  font-weight: 500;
  width: 75px;
  flex-shrink: 0;
  font-size: 10px;
  letter-spacing: 0.3px;
}
.log-msg {
  color: var(--ink-secondary);
  flex: 1;
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* ─── META CARDS ─── */
.meta-card {
  background: var(--ob-layer);
  border: 1px solid var(--line-faint);
  border-radius: var(--radius-md);
  padding: 14px 16px;
  margin-bottom: 8px;
  transition: border-color 0.3s ease;
}
.meta-card:hover { border-color: var(--line-medium); }
.meta-card-title {
  font-size: 9px;
  color: var(--accent);
  text-transform: uppercase;
  letter-spacing: 1.5px;
  margin-bottom: 8px;
  font-weight: 400;
}
.meta-card-text {
  font-size: 12px;
  color: var(--ink-secondary);
  line-height: 1.7;
}

.adj-row {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 12px;
  background: var(--ob-void);
  border: 1px solid var(--line-faint);
  border-radius: var(--radius-md);
  margin-top: 4px;
  font-size: 11px;
  transition: border-color 0.3s ease;
}
.adj-row:hover { border-color: var(--line-medium); }
.adj-engine { color: var(--accent); font-weight: 500; width: 55px; font-size: 10px; letter-spacing: 0.5px; }
.adj-param { color: var(--ink-primary); flex: 1; }
.adj-change { color: var(--signal-warn); font-weight: 500; white-space: nowrap; }

/* ─── KILL SWITCH ─── */
.kill-switch-banner {
  margin-top: 10px;
  padding: 8px 12px;
  background: rgba(198,122,110,0.06);
  border: 1px solid rgba(198,122,110,0.2);
  border-radius: var(--radius-md);
  font-size: 11px;
  color: var(--signal-loss-bright);
  font-weight: 500;
  letter-spacing: 0.5px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.kill-switch-banner::before {
  content: '';
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--signal-loss);
  animation: kill-blink 1s ease-in-out infinite;
}
@keyframes kill-blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}

/* ─── EMPTY STATE ─── */
.empty-state {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100%;
  min-height: 60px;
  color: var(--ink-ghost);
  font-size: 11px;
  letter-spacing: 0.5px;
}

/* ─── QUOTE TABLE LINKS ─── */
.quote-link {
  color: var(--ink-secondary);
  text-decoration: none;
  transition: color 0.2s ease;
  border-bottom: 1px solid transparent;
}
.quote-link:hover {
  color: var(--accent);
  border-bottom-color: var(--accent-dim);
}

/* ─── FADE-IN ANIMATION ─── */
@keyframes panel-enter {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}
.panel {
  animation: panel-enter 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
}
.panel:nth-child(1) { animation-delay: 0.05s; }
.panel:nth-child(2) { animation-delay: 0.1s; }
.panel:nth-child(3) { animation-delay: 0.15s; }
.panel:nth-child(4) { animation-delay: 0.2s; }
.panel:nth-child(5) { animation-delay: 0.25s; }
.panel:nth-child(6) { animation-delay: 0.3s; }
.panel:nth-child(7) { animation-delay: 0.35s; }
.panel:nth-child(8) { animation-delay: 0.4s; }

/* ─── RESPONSIVE ─── */

/* Tablet landscape / small desktop */
@media (max-width: 1200px) {
  .grid { grid-template-columns: repeat(2, 1fr); }
  .span-3 { grid-column: span 2; }
  .span-4 { grid-column: span 2; }
  .header { padding: 0 20px; }
  .header-right { gap: 20px; }
  .header-stat-value { font-size: 15px; }
  .inv-label { min-width: 140px; max-width: 160px; }
}

/* Tablet portrait */
@media (max-width: 960px) {
  .header {
    flex-direction: column;
    height: auto;
    padding: 14px 16px;
    gap: 12px;
    align-items: stretch;
  }
  .header-left {
    justify-content: center;
    flex-wrap: wrap;
    gap: 12px;
  }
  .header-right {
    justify-content: center;
    gap: 24px;
  }
  .header-stat { text-align: center; }
  .header-divider { display: none; }

  .dtable { font-size: 11px; }
  .dtable th { font-size: 8px; letter-spacing: 0.5px; }
  .dtable td { padding: 6px 2px; }
}

/* Mobile */
@media (max-width: 768px) {
  .grid {
    grid-template-columns: 1fr;
    gap: 0;
    background: var(--ob-void);
  }
  .span-2, .span-3, .span-4 { grid-column: span 1; }

  /* Add spacing between stacked panels */
  .panel { margin-bottom: 2px; }

  .panel-body { padding: 14px 14px; }
  .panel-header { padding: 10px 14px; min-height: 38px; }
  .panel-title { font-size: 10px; letter-spacing: 1.5px; }

  /* Metrics become more compact */
  .metric { padding: 10px 12px; }
  .metric-value { font-size: 17px; }
  .metric-label { font-size: 8px; letter-spacing: 1px; }

  /* Inventory bars — reduce label width */
  .inv-label { min-width: 120px; max-width: 140px; font-size: 10px; }
  .inv-track { height: 18px; }
  .inv-value { font-size: 10px; width: 45px; }
  .inv-row { gap: 6px; margin-bottom: 8px; }

  /* Quotes table — horizontal scroll on small screens */
  .panel:has(#quote-table) .panel-body {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  .dtable { min-width: 500px; }
  .dtable td { white-space: nowrap; font-size: 11px; }

  /* Signal rows */
  .signal-row { padding: 8px 10px; gap: 8px; }
  .signal-market { font-size: 10px; }
  .signal-detail { font-size: 9px; }
  .signal-badge { font-size: 8px; padding: 2px 6px; }

  /* Log entries */
  .log-entry { font-size: 10px; gap: 6px; }
  .log-time { width: 40px; font-size: 9px; }
  .log-type { width: 60px; font-size: 9px; }

  /* PnL bars */
  .pnl-bar-label { font-size: 9px; width: 36px; }
  .pnl-bar-value { font-size: 10px; width: 55px; }
  .pnl-bar-track { height: 16px; }

  /* Meta cards */
  .meta-card { padding: 10px 12px; }
  .meta-card-title { font-size: 8px; }
  .meta-card-text { font-size: 11px; }
  .adj-row { padding: 6px 8px; font-size: 10px; }
}

/* Small mobile (iPhone SE, etc.) */
@media (max-width: 420px) {
  .header-left { gap: 8px; }
  .logo { font-size: 17px; }
  .logo-version { font-size: 9px; padding: 1px 5px; }
  .mode-badge { padding: 3px 8px; font-size: 9px; letter-spacing: 1.5px; }
  .uptime-cluster { font-size: 10px; }

  .header-right { gap: 16px; flex-wrap: wrap; }
  .header-stat-label { font-size: 8px; }
  .header-stat-value { font-size: 14px; }

  .metrics { gap: 4px; }
  .metrics-3 { grid-template-columns: repeat(3, 1fr); }
  .metric { padding: 8px 8px; }
  .metric-value { font-size: 15px; }

  .inv-label { min-width: 100px; max-width: 120px; font-size: 9px; }

  .panel-body { padding: 10px 10px; }
}
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="header-left">
    <div class="logo">
      <span class="logo-mark">Poly</span>Edge
      <span class="logo-version">v4.0</span>
    </div>
    <div class="mode-badge mode-paper" id="mode-badge">PAPER</div>
    <div class="uptime-cluster">
      <span class="status-dot dot-green" id="status-dot"></span>
      <span id="uptime">0h 0m</span>
    </div>
  </div>
  <div class="header-right">
    <div class="header-stat">
      <div class="header-stat-label">Total PnL</div>
      <div class="header-stat-value stat-neutral" id="total-pnl">$0.00</div>
    </div>
    <div class="header-divider"></div>
    <div class="header-stat">
      <div class="header-stat-label">Exposure</div>
      <div class="header-stat-value stat-neutral" id="total-exposure">$0 / $500</div>
    </div>
    <div class="header-divider"></div>
    <div class="header-stat">
      <div class="header-stat-label">Engines</div>
      <div class="header-stat-value stat-neutral" id="engine-count">0 / 3</div>
    </div>
  </div>
</div>

<!-- Dashboard Grid -->
<div class="grid">

  <!-- Panel 1: System Status -->
  <div class="panel">
    <div class="panel-header">
      <span class="panel-title">System Status</span>
      <span class="panel-tag tag-risk">LIVE</span>
    </div>
    <div class="panel-body">
      <div class="metrics" id="system-metrics">
        <div class="metric">
          <div class="metric-label">Bankroll</div>
          <div class="metric-value" id="sys-bankroll">$5,000</div>
        </div>
        <div class="metric">
          <div class="metric-label">ROI</div>
          <div class="metric-value stat-neutral" id="sys-roi">0.00%</div>
        </div>
        <div class="metric">
          <div class="metric-label">MM Status</div>
          <div class="metric-value" id="sys-mm-status">&mdash;</div>
        </div>
        <div class="metric">
          <div class="metric-label">Sniper Status</div>
          <div class="metric-value" id="sys-sniper-status">&mdash;</div>
        </div>
        <div class="metric">
          <div class="metric-label">Meta Next Run</div>
          <div class="metric-value" id="sys-meta-next">&mdash;</div>
        </div>
        <div class="metric">
          <div class="metric-label">CLOB</div>
          <div class="metric-value" id="sys-clob">&mdash;</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Panel 2: Market Maker Overview -->
  <div class="panel">
    <div class="panel-header">
      <span class="panel-title">Market Maker</span>
      <span class="panel-tag tag-engine">Engine 1</span>
    </div>
    <div class="panel-body">
      <div class="metrics metrics-3" id="mm-metrics">
        <div class="metric">
          <div class="metric-label">Markets</div>
          <div class="metric-value" id="mm-markets">0</div>
        </div>
        <div class="metric">
          <div class="metric-label">Quotes</div>
          <div class="metric-value" id="mm-quotes">0</div>
        </div>
        <div class="metric">
          <div class="metric-label">Fills</div>
          <div class="metric-value" id="mm-fills">0</div>
        </div>
      </div>
      <div style="margin-top:14px">
        <div class="pnl-bar">
          <span class="pnl-bar-label">Real</span>
          <div class="pnl-bar-track">
            <div class="pnl-bar-fill" id="mm-real-bar" style="width:50%;left:50%;background:var(--signal-profit)"></div>
          </div>
          <span class="pnl-bar-value stat-neutral" id="mm-real-pnl">$0.00</span>
        </div>
        <div class="pnl-bar">
          <span class="pnl-bar-label">Unreal</span>
          <div class="pnl-bar-track">
            <div class="pnl-bar-fill" id="mm-unreal-bar" style="width:50%;left:50%;background:var(--signal-warn)"></div>
          </div>
          <span class="pnl-bar-value stat-neutral" id="mm-unreal-pnl">$0.00</span>
        </div>
      </div>
      <div class="kill-switch-banner" id="mm-kill-switch" style="display:none;">
        KILL SWITCH TRIGGERED
      </div>
    </div>
  </div>

  <!-- Panel 3: Quote Book -->
  <div class="panel span-2">
    <div class="panel-header">
      <span class="panel-title">Active Quotes</span>
      <span class="panel-tag tag-engine">MM Live</span>
    </div>
    <div class="panel-body">
      <table class="dtable" id="quote-table">
        <thead>
          <tr>
            <th>Market</th>
            <th>Bid</th>
            <th>Ask</th>
            <th>Spread</th>
            <th>Size</th>
            <th>Fair Value</th>
          </tr>
        </thead>
        <tbody id="quote-tbody">
          <tr><td colspan="6" class="empty-state">Waiting for quotes...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Panel 4: Inventory Heatmap -->
  <div class="panel">
    <div class="panel-header">
      <span class="panel-title">Inventory</span>
      <span class="panel-tag tag-risk">Risk</span>
    </div>
    <div class="panel-body" id="inventory-panel">
      <div class="empty-state">No positions</div>
    </div>
  </div>

  <!-- Panel 5: Sniper Feed -->
  <div class="panel">
    <div class="panel-header">
      <span class="panel-title">Sniper Trades</span>
      <span class="panel-tag tag-engine">Engine 2</span>
    </div>
    <div class="panel-body" id="sniper-panel">
      <div class="metrics" style="margin-bottom:14px">
        <div class="metric">
          <div class="metric-label">Trades</div>
          <div class="metric-value" id="sniper-trades">0</div>
        </div>
        <div class="metric">
          <div class="metric-label">Win Rate</div>
          <div class="metric-value" id="sniper-winrate">0%</div>
        </div>
      </div>
      <div id="sniper-positions"></div>
    </div>
  </div>

  <!-- Panel 6: Gap Radar -->
  <div class="panel span-2">
    <div class="panel-header">
      <span class="panel-title">Gap Radar</span>
      <span class="panel-tag tag-feed">Signals</span>
    </div>
    <div class="panel-body" id="gap-panel">
      <div class="empty-state">Waiting for events...</div>
    </div>
  </div>

  <!-- Panel 7: Live Events Log -->
  <div class="panel span-2">
    <div class="panel-header">
      <span class="panel-title">Event Log</span>
      <span class="panel-tag tag-feed">Feeds</span>
    </div>
    <div class="panel-body" id="event-log">
      <div class="empty-state">No events yet</div>
    </div>
  </div>

  <!-- Panel 8: Meta Strategist -->
  <div class="panel span-2">
    <div class="panel-header">
      <span class="panel-title">Meta Strategist</span>
      <span class="panel-tag tag-meta">Engine 3</span>
    </div>
    <div class="panel-body" id="meta-panel">
      <div class="metrics" style="margin-bottom:14px">
        <div class="metric">
          <div class="metric-label">Runs</div>
          <div class="metric-value" id="meta-runs">0</div>
        </div>
        <div class="metric">
          <div class="metric-label">LLM Cost</div>
          <div class="metric-value" id="meta-cost">$0.00</div>
        </div>
        <div class="metric">
          <div class="metric-label">Adjustments</div>
          <div class="metric-value" id="meta-adjustments">0</div>
        </div>
        <div class="metric">
          <div class="metric-label">Next Run</div>
          <div class="metric-value" id="meta-next-run">&mdash;</div>
        </div>
      </div>
      <div id="meta-reports"></div>
    </div>
  </div>

</div>

<script>
// ─────────────────────────────────────────────
// PolyEdge v4 Dashboard — Client
// ─────────────────────────────────────────────

const API_BASE = window.location.origin;
const REFRESH_MS = 5000; // 5 second refresh

// ── State ──
let state = {
  status: null,
  mm: null,
  sniper: null,
  meta: null,
  eventLog: [],
};

// ── Fetch Helpers ──
async function fetchJSON(endpoint) {
  try {
    const resp = await fetch(`${API_BASE}${endpoint}`, { signal: AbortSignal.timeout(4000) });
    if (!resp.ok) return null;
    return await resp.json();
  } catch (e) {
    return null;
  }
}

// ── Formatting ──
function fmt$(v, decimals = 2) {
  if (v == null) return '\u2014';
  const s = v >= 0 ? '' : '-';
  return `${s}$${Math.abs(v).toFixed(decimals)}`;
}
function fmtPct(v) { return v != null ? `${v.toFixed(1)}%` : '\u2014'; }
function fmtTime(secs) {
  if (secs == null) return '\u2014';
  const h = Math.floor(secs / 3600);
  const m = Math.floor((secs % 3600) / 60);
  return h > 0 ? `${h}h ${m}m` : `${m}m`;
}
function fmtPrice(v) { return v != null ? v.toFixed(3) : '\u2014'; }
function fmtShort(s, len = 45) {
  if (!s) return '\u2014';
  return s.length > len ? s.substring(0, len) + '\u2026' : s;
}
function pnlClass(v) {
  if (v > 0.01) return 'stat-positive';
  if (v < -0.01) return 'stat-negative';
  return 'stat-neutral';
}
function urgencyClass(u) {
  const map = { CRITICAL: 'badge-critical', HIGH: 'badge-high', MEDIUM: 'badge-medium', LOW: 'badge-low' };
  return map[u] || 'badge-low';
}

// ── Update Functions ──

function updateHeader(data) {
  if (!data) return;
  const engines = data.engines || {};
  const mm = engines.market_maker || {};
  const sn = engines.sniper || {};
  const me = engines.meta || {};

  // Mode
  const badge = document.getElementById('mode-badge');
  if (data.mode === 'LIVE') {
    badge.textContent = 'LIVE';
    badge.className = 'mode-badge mode-live';
  } else {
    badge.textContent = 'PAPER';
    badge.className = 'mode-badge mode-paper';
  }

  // Uptime
  document.getElementById('uptime').textContent = fmtTime((data.uptime_hours || 0) * 3600);

  // Status dot
  const dot = document.getElementById('status-dot');
  dot.className = 'status-dot dot-green';

  // PnL
  const mmPnl = (mm.pnl?.realized || 0) + (mm.pnl?.unrealized || 0);
  const snPnl = sn.executor?.total_pnl || 0;
  const totalPnl = mmPnl + snPnl;
  const el = document.getElementById('total-pnl');
  el.textContent = fmt$(totalPnl);
  el.className = 'header-stat-value ' + pnlClass(totalPnl);

  // Exposure
  const mmExp = mm.inventory?.total_exposure || 0;
  const snExp = sn.executor?.total_exposure || 0;
  document.getElementById('total-exposure').textContent = `$${(mmExp + snExp).toFixed(0)} / $500`;

  // Engines count
  let running = 0;
  if (mm.status === 'running') running++;
  if (sn.status === 'running') running++;
  if (me.status === 'running') running++;
  document.getElementById('engine-count').textContent = `${running} / 3`;
}

function updateSystem(data) {
  if (!data) return;
  const engines = data.engines || {};
  const mm = engines.market_maker || {};
  const sn = engines.sniper || {};
  const me = engines.meta || {};

  const mmPnl = (mm.pnl?.realized || 0) + (mm.pnl?.unrealized || 0);
  const snPnl = sn.executor?.total_pnl || 0;
  const totalPnl = mmPnl + snPnl;
  const roi = totalPnl / 5000 * 100;

  document.getElementById('sys-bankroll').textContent = '$5,000';
  const roiEl = document.getElementById('sys-roi');
  roiEl.textContent = fmtPct(roi);
  roiEl.className = 'metric-value ' + pnlClass(roi);

  document.getElementById('sys-mm-status').textContent = mm.status || 'stopped';
  document.getElementById('sys-mm-status').style.color = mm.status === 'running' ? 'var(--signal-profit)' : 'var(--ink-tertiary)';

  document.getElementById('sys-sniper-status').textContent = sn.status || 'stopped';
  document.getElementById('sys-sniper-status').style.color = sn.status === 'running' ? 'var(--signal-profit)' : 'var(--ink-tertiary)';

  document.getElementById('sys-meta-next').textContent = me.next_run_in_hours != null ? `${me.next_run_in_hours}h` : '\u2014';
  document.getElementById('sys-clob').textContent = data.mode || '\u2014';
}

function updateMM(mm) {
  if (!mm) return;
  document.getElementById('mm-markets').textContent = mm.active_markets || 0;
  document.getElementById('mm-quotes').textContent = mm.quote_count || 0;
  document.getElementById('mm-fills').textContent = mm.fill_count || 0;

  const realPnl = mm.pnl?.realized || 0;
  const unrealPnl = mm.pnl?.unrealized || 0;

  const realEl = document.getElementById('mm-real-pnl');
  realEl.textContent = fmt$(realPnl);
  realEl.className = 'pnl-bar-value ' + pnlClass(realPnl);

  const unrealEl = document.getElementById('mm-unreal-pnl');
  unrealEl.textContent = fmt$(unrealPnl);
  unrealEl.className = 'pnl-bar-value ' + pnlClass(unrealPnl);

  // Bars (center = 0, max = $50)
  const maxBar = 50;
  const realW = Math.min(Math.abs(realPnl) / maxBar * 50, 50);
  const realBar = document.getElementById('mm-real-bar');
  if (realPnl >= 0) {
    realBar.style.left = '50%'; realBar.style.right = 'auto';
    realBar.style.background = 'var(--signal-profit)';
  } else {
    realBar.style.right = '50%'; realBar.style.left = 'auto';
    realBar.style.background = 'var(--signal-loss)';
  }
  realBar.style.width = realW + '%';

  const unrealW = Math.min(Math.abs(unrealPnl) / maxBar * 50, 50);
  const unrealBar = document.getElementById('mm-unreal-bar');
  if (unrealPnl >= 0) {
    unrealBar.style.left = '50%'; unrealBar.style.right = 'auto';
    unrealBar.style.background = 'var(--signal-profit)';
  } else {
    unrealBar.style.right = '50%'; unrealBar.style.left = 'auto';
    unrealBar.style.background = 'var(--signal-warn)';
  }
  unrealBar.style.width = unrealW + '%';

  // Kill switch
  const ks = document.getElementById('mm-kill-switch');
  ks.style.display = (mm.kill_switch || mm.inventory?.kill_switch) ? 'flex' : 'none';

  // Quote table
  // Convert quotes dict → array for table rendering
  let quotesArr = mm.active_quotes || [];
  if (mm.quotes && typeof mm.quotes === 'object' && !Array.isArray(mm.quotes)) {
    quotesArr = Object.entries(mm.quotes).map(([tid, q]) => ({
      condition_id: tid,
      bid_price: q.bid ? parseFloat(q.bid.split('x')[0]) : null,
      ask_price: q.ask ? parseFloat(q.ask.split('x')[0]) : null,
      bid_size: q.bid ? parseFloat(q.bid.split('x')[1]) : 0,
      ask_size: q.ask ? parseFloat(q.ask.split('x')[1]) : 0,
      spread: q.bid && q.ask ? parseFloat(q.ask.split('x')[0]) - parseFloat(q.bid.split('x')[0]) : null,
      fair_value: q.fair_value,
      market: q.question || tid.substring(0, 12) + '\u2026',
      url: q.url || '',
    }));
  }
  updateQuotes(quotesArr);

  // Build token_id → question name lookup from quotes AND token_names
  const tokenNames = {};
  if (mm.quotes && typeof mm.quotes === 'object') {
    Object.entries(mm.quotes).forEach(([tid, q]) => {
      if (q.question) tokenNames[tid] = q.question;
      if (q.url) tokenNames[tid + '_url'] = q.url;
    });
  }
  // Also from token_names map (covers YES + NO tokens)
  if (mm.token_names && typeof mm.token_names === 'object') {
    Object.entries(mm.token_names).forEach(([tid, info]) => {
      if (info.question && !tokenNames[tid]) tokenNames[tid] = info.question;
      if (info.url && !tokenNames[tid + '_url']) tokenNames[tid + '_url'] = info.url;
    });
  }
  // Also from markets array
  if (mm.markets && Array.isArray(mm.markets)) {
    mm.markets.forEach(m => {
      if (m.question && m.token_id) tokenNames[m.token_id] = m.question;
    });
  }
  updateInventory(mm.inventory?.positions || {}, tokenNames);
}

function updateQuotes(quotes) {
  const tbody = document.getElementById('quote-tbody');
  if (!quotes || quotes.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No active quotes</td></tr>';
    return;
  }
  tbody.innerHTML = quotes.map(q => {
    const label = q.url
      ? `<a href="${q.url}" target="_blank" class="quote-link" title="${q.market}">${q.market}</a>`
      : (q.market || q.condition_id);
    return `
    <tr>
      <td style="max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${q.market || q.condition_id}">${label}</td>
      <td style="color:var(--signal-profit)">${fmtPrice(q.bid_price)}</td>
      <td style="color:var(--signal-loss)">${fmtPrice(q.ask_price)}</td>
      <td style="color:var(--signal-warn)">${q.spread ? (q.spread * 100).toFixed(1) + '\u00a2' : '\u2014'}</td>
      <td>$${(q.bid_size || 0).toFixed(0)}</td>
      <td style="color:var(--accent)">${fmtPrice(q.fair_value)}</td>
    </tr>
  `}).join('');
}

function updateInventory(positions, tokenNames) {
  tokenNames = tokenNames || {};
  const panel = document.getElementById('inventory-panel');
  if (!positions || Object.keys(positions).length === 0) {
    panel.innerHTML = '<div class="empty-state">No positions</div>';
    return;
  }

  const maxPos = 50; // $50 max per market
  panel.innerHTML = Object.entries(positions).map(([market, pos]) => {
    const net = pos.net_position || pos.net || 0;
    const tid = pos.token_id || market;
    const name = tokenNames[tid] || tokenNames[market] || fmtShort(market, 14);
    const url = tokenNames[tid + '_url'] || tokenNames[market + '_url'] || '';
    const pct = Math.min(Math.abs(net) / maxPos * 50, 50);
    const isLong = net > 0;
    const label = url
      ? `<a href="${url}" target="_blank" style="color:inherit;text-decoration:none" title="${name}">${name}</a>`
      : `<span title="${name}">${name}</span>`;
    return `
      <div class="inv-row">
        <span class="inv-label" style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${label}</span>
        <div class="inv-track">
          <div class="inv-center"></div>
          ${isLong
            ? `<div class="inv-fill-long" style="width:${pct}%"></div>`
            : `<div class="inv-fill-short" style="width:${pct}%"></div>`
          }
        </div>
        <span class="inv-value" style="color:${isLong ? 'var(--signal-profit)' : 'var(--signal-loss)'}">
          ${net >= 0 ? '+' : ''}${net.toFixed(1)}
        </span>
      </div>
    `;
  }).join('');
}

function updateSniper(sn) {
  if (!sn) return;
  const exec = sn.executor || {};
  document.getElementById('sniper-trades').textContent = sn.trades_executed || 0;
  document.getElementById('sniper-winrate').textContent = fmtPct(exec.win_rate || 0);

  // Active positions
  const posDiv = document.getElementById('sniper-positions');
  const positions = exec.active_positions || [];
  if (positions.length === 0) {
    posDiv.innerHTML = '<div class="empty-state">No active sniper positions</div>';
    return;
  }

  posDiv.innerHTML = positions.map(p => `
    <div class="signal-row ${p.direction === 'BUY' ? 'signal-buy' : 'signal-sell'}">
      <div class="signal-info">
        <div class="signal-market">${fmtShort(p.market, 40)}</div>
        <div class="signal-detail">${p.direction} $${p.size?.toFixed(0)} @ ${p.entry?.toFixed(3)} \u00b7 edge ${p.edge}%</div>
      </div>
      <span style="font-size:11px;color:var(--ink-tertiary)">${p.age_s}s</span>
    </div>
  `).join('');
}

function updateGapRadar(sn) {
  if (!sn) return;
  const signals = sn.recent_signals || [];
  const panel = document.getElementById('gap-panel');

  if (signals.length === 0) {
    panel.innerHTML = '<div class="empty-state">No gap signals detected</div>';
    return;
  }

  panel.innerHTML = signals.map(s => `
    <div class="signal-row ${s.direction === 'BUY' ? 'signal-buy' : 'signal-sell'}">
      <div class="signal-info">
        <div class="signal-market">${fmtShort(s.market, 50)}</div>
        <div class="signal-detail">${s.trigger} \u00b7 ${s.gap_cents?.toFixed(1)}\u00a2 gap \u00b7 ${s.reasoning}</div>
      </div>
      <span class="signal-badge ${urgencyClass(s.urgency)}">${s.urgency}</span>
      <span style="font-size:13px;font-weight:600;color:${s.direction === 'BUY' ? 'var(--signal-profit-bright)' : 'var(--signal-loss-bright)'}">
        ${s.edge_pct?.toFixed(1)}%
      </span>
    </div>
  `).join('');
}

function updateEventLog(sn) {
  if (!sn) return;
  const events = sn.recent_signals || [];
  const log = document.getElementById('event-log');

  if (events.length === 0 && state.eventLog.length === 0) {
    log.innerHTML = '<div class="empty-state">No events yet</div>';
    return;
  }

  // Merge new signals into event log
  events.forEach(e => {
    const key = `${e.trigger}-${e.market?.substring(0,20)}`;
    if (!state.eventLog.find(x => x.key === key)) {
      state.eventLog.unshift({
        key,
        time: new Date(),
        type: e.trigger,
        msg: `${e.direction} ${e.gap_cents?.toFixed(1)}\u00a2 gap on ${fmtShort(e.market, 40)}`,
        color: e.direction === 'BUY' ? 'var(--signal-profit)' : 'var(--signal-loss)',
      });
    }
  });

  state.eventLog = state.eventLog.slice(0, 50);

  log.innerHTML = state.eventLog.map(e => {
    const t = e.time;
    const ts = `${String(t.getHours()).padStart(2,'0')}:${String(t.getMinutes()).padStart(2,'0')}`;
    return `
      <div class="log-entry">
        <span class="log-time">${ts}</span>
        <span class="log-type" style="color:${e.color || 'var(--ink-secondary)'}">${e.type}</span>
        <span class="log-msg">${e.msg}</span>
      </div>
    `;
  }).join('');
}

function updateMeta(meta) {
  if (!meta) return;
  document.getElementById('meta-runs').textContent = meta.run_count || 0;
  document.getElementById('meta-cost').textContent = fmt$(meta.total_llm_cost || 0, 4);

  const adjs = meta.adjustment_history || [];
  document.getElementById('meta-adjustments').textContent = adjs.length;
  document.getElementById('meta-next-run').textContent =
    meta.next_run_in_hours != null ? `${meta.next_run_in_hours}h` : '\u2014';

  const reportsDiv = document.getElementById('meta-reports');
  const reports = meta.recent_reports || [];

  if (reports.length === 0) {
    reportsDiv.innerHTML = '<div class="empty-state">No reports yet (first run after 1h)</div>';
    return;
  }

  reportsDiv.innerHTML = reports.reverse().map(r => `
    <div class="meta-card">
      <div class="meta-card-title">${r.time} \u00b7 PnL ${fmt$(r.total_pnl)} \u00b7 ${r.adjustments} adj \u00b7 ${fmt$(r.cost, 4)} cost</div>
      <div class="meta-card-text">${r.summary}</div>
    </div>
  `).join('');

  // Recent adjustments
  if (adjs.length > 0) {
    reportsDiv.innerHTML += '<div style="margin-top:12px">' +
      adjs.slice(-5).reverse().map(a => `
        <div class="adj-row">
          <span class="adj-engine">${a.engine?.toUpperCase()}</span>
          <span class="adj-param">${a.parameter}</span>
          <span class="adj-change">${a.old_value} \u2192 ${a.new_value}</span>
        </div>
      `).join('') + '</div>';
  }
}

// ── Main Refresh Loop ──
async function refresh() {
  const [statusData, mmData, sniperData, metaData] = await Promise.all([
    fetchJSON('/api/status'),
    fetchJSON('/api/mm'),
    fetchJSON('/api/sniper'),
    fetchJSON('/api/meta'),
  ]);

  state.status = statusData;
  state.mm = mmData;
  state.sniper = sniperData;
  state.meta = metaData;

  updateHeader(statusData);
  updateSystem(statusData);
  updateMM(mmData);
  updateSniper(sniperData);
  updateGapRadar(sniperData);
  updateEventLog(sniperData);
  updateMeta(metaData);
}

// Start
refresh();
setInterval(refresh, REFRESH_MS);

// Log startup
console.log('PolyEdge v4 Dashboard initialized \u2014 refreshing every 5s');
</script>
</body>
</html>
